<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reazione a Cancrena - V3</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
   <style>
    /* Importa Font */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

    /* === NUOVA PALETTE DARK THEME === */
    :root {
        /* Colori Logo */
        --logo-red: #be4636;
        --logo-yellow: #eeb045;
        --logo-green: #65a538;

        /* Dark Theme Base */
        --bg-main: #1c1c1c; /* Sfondo quasi nero */
        --bg-card: #2a2a2a; /* Grigio scuro per card e sidebar */
        --bg-item: #383838; /* Grigio medio per elementi lista */
        --text-main: #f0f0f0; /* Testo principale bianco sporco */
        --text-secondary: #b0b0b0; /* Testo secondario grigio chiaro */
        --border-color: #444444; /* Colore bordi sottili */

        /* Colori UI basati sul Logo + Dark Theme */
        --primary-color: var(--logo-red); /* Rosso Logo come primario */
        --primary-dark: #a33526; /* Rosso più scuro per hover */
        --secondary-color: var(--logo-yellow); /* Giallo Logo come secondario (titoli?) */
        --warning-color: var(--logo-yellow); /* Giallo per bottoni "Termina" */
        --warning-dark: #d49d39;
        --accent-color: var(--logo-green); /* Verde Logo come accento (es. Like) */
        --accent-dark: #4f832a;

        /* Colori Specifici Componenti */
        --winner-bg: var(--logo-yellow); /* Giallo per sfondo vincitore */
        --challenge-color: #9b59b6; /* Viola/Fucsia per contrasto Sfida */
        --challenge-dark: #8e44ad;
        --couple-color: #3498db; /* Blu per Coppie */
        --couple-dark: #2980b9;
        --highlight-bg: #404040;  /* Sfondo per nomi evidenziati */

        /* Colori Bottoni Azione Scoreboard */
        --like-color: var(--accent-color); /* Verde Logo */
        --dislike-color: #e74c3c; /* Rosso standard per Dislike */
        --vote-color: var(--secondary-color); /* Giallo per Trofeo Voto */

        /* Layout & Stili Generali (invariati) */
        --border-radius-main: 12px;
        --box-shadow-light: 0 4px 15px rgba(0, 0, 0, 0.4); /* Ombre più scure */
        --box-shadow-medium: 0 6px 20px rgba(0, 0, 0, 0.5);
    }
    /* === FINE PALETTE === */


    body {
        font-family: 'Poppins', sans-serif;
        margin: 0; padding: 20px; /* Tolto align-items */
        background-color: var(--bg-main); /* Usa sfondo principale dark */
        color: var(--text-main); /* Usa testo principale light */
        line-height: 1.6;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        box-sizing: border-box;
    }

    /* Layout Principale (invariato) */
    .main-layout { display: flex; gap: 25px; width: 100%; max-width: 1200px; }
    .game-content { flex-grow: 1; min-width: 0; }
    .scoreboard-sidebar {
        flex-basis: 300px; flex-shrink: 0;
        background-color: var(--bg-card); /* Sfondo Card */
        border-radius: var(--border-radius-main);
        padding: 20px; box-shadow: var(--box-shadow-medium);
        height: fit-content; position: sticky; top: 20px;
    }

    /* Logo e Titoli */
     .logo-container { /* Nuovo contenitore logo */
          text-align: center;
          margin-bottom: 30px;
     }
     .logo-container img {
          max-width: 300px; /* O dimensione preferita */
          height: auto;
          filter: drop-shadow(0 3px 5px rgba(0,0,0,0.4)); /* Aggiunge ombra al logo */
     }
     /* H1 Rimosso, non serve stile */
     .game-content h2 {
        color: var(--secondary-color); /* Giallo Logo per titoli sezione */
        margin-top: 0; margin-bottom: 25px; font-weight: 600;
        text-align: center; border-bottom: 1px solid var(--border-color); /* Bordo visibile */
        padding-bottom: 10px;
    }
    .game-content h3 { /* Titolo coppie */
        color: var(--text-main); /* Testo chiaro */
        margin-top: 25px; margin-bottom: 15px; font-weight: 600;
        text-align: center; font-size: 1.1em;
    }
     .scoreboard-sidebar h2 {
         margin-top: 0; font-size: 1.5em; color: var(--secondary-color); /* Giallo Logo */
         border-bottom: 2px solid var(--secondary-color); padding-bottom: 8px; text-align: center;
    }


    /* Input / Select / Button nel Setup */
    #setup-section input[type="text"], #setup-section select {
        padding: 12px 15px; margin: 5px 0 10px 0; border-radius: 8px;
        border: 1px solid var(--border-color); /* Bordo visibile */
        width: calc(100% - 32px); font-size: 1em; box-sizing: border-box;
        transition: border-color 0.3s, box-shadow 0.3s;
        background-color: var(--bg-item); /* Sfondo input scuro */
        color: var(--text-main); /* Testo input chiaro */
    }
    #setup-section select { /* Stile specifico select */
        width: 100%; margin-bottom: 15px; appearance: none;
        /* Freccia SVG scura - difficile farla dinamica con var(), usiamo un colore fisso o un SVG inline */
         background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23cccccc%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
         background-repeat: no-repeat; background-position: right 15px center; background-size: 10px auto; padding-right: 40px;
    }
    #setup-section input[type="text"]:focus, #setup-section select:focus {
        outline: none; border-color: var(--secondary-color); /* Focus Giallo */
        box-shadow: 0 0 8px rgba(238, 176, 69, 0.5); /* Ombra Gialla */
    }
    .input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
    .input-group input { flex-grow: 1; margin: 0; }
    .input-group button { margin: 0; flex-shrink: 0; padding: 12px 20px; }

     /* Stile Bottoni Generico */
     button { padding: 12px 25px; margin: 10px 5px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 1em; text-transform: uppercase; letter-spacing: 0.5px; transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s; color: var(--text-main); /* Testo chiaro di default */ }
     button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--box-shadow-light); }
     button:active:not(:disabled) { transform: translateY(0px); }
     button:disabled { background-color: #555 !important; /* Grigio scuro disabilitato */ cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.6; color: #999; }

     /* Bottoni Setup (Primari) */
    .input-group button, #start-btn, #couple-btn { background-color: var(--primary-color); /* Rosso Logo */ }
    .input-group button:hover:not(:disabled), #start-btn:hover:not(:disabled), #couple-btn:hover:not(:disabled) { background-color: var(--primary-dark); }

     /* Lista Giocatori Setup */
     ul#players-list { list-style-type: none; padding: 0; margin-top: 20px; margin-bottom: 30px; }
     li.player-item { padding: 10px 12px; margin: 6px 0; background-color: var(--bg-item); border-radius: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 1em; transition: background-color 0.3s; gap: 8px; }
     li.player-item:hover { background-color: #4a4a4a; }
     .player-name { flex-grow: 1; font-weight: 600; color: var(--text-main); }
     .couple-icon { color: var(--couple-icon-color); font-size: 1em; margin: 0 3px; }
     .player-actions button { padding: 5px 8px; font-size: 0.8em; text-transform: none; letter-spacing: 0; margin: 0 2px; min-width: 60px; text-align: center; color: var(--text-main); /* Testo chiaro anche qui */}
     .player-actions button:hover { transform: none; box-shadow: none; }
     .delete-btn { background-color: #555; }
     .delete-btn:hover { background-color: #777; }
     .uncouple-btn { background-color: var(--warning-color); display: none; }
     .uncouple-btn:hover { background-color: var(--warning-dark); }
      /* Sezione Coppie Setup */
      #couple-section { margin-top: 30px; padding: 20px; border: 1px solid var(--border-color); border-radius: var(--border-radius-main); background-color: var(--bg-card); }
      .couple-selectors { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; }
      .couple-selectors label { flex-basis: 100px; text-align: right; font-weight: 600; font-size: 0.9em; color: var(--text-secondary); }
      .couple-selectors > div { flex-grow: 1; }
      #couple-btn { display: block; width: 100%; margin-top: 10px; }

    /* === SEZIONE GIOCO (#game-section) === */
    #setup-section, #game-section, #scoreboard-section {
         background-color: var(--bg-card); /* Sfondo Card per tutte le sezioni */
         border-radius: var(--border-radius-main);
         padding: 30px 40px;
         box-shadow: var(--box-shadow-medium);
     }
     .challenge-card {
        padding: 25px 30px; margin: 0 0 20px 0;
        min-height: 280px; display: flex; flex-direction: column; justify-content: center;
        transition: background-color 0.5s ease, border-color 0.5s ease;
        border: 2px solid var(--border-color); /* Bordo base */
        overflow: hidden; text-align: center;
         border-radius: var(--border-radius-main); /* Assicura bordi arrotondati */
         background: none; /* Rimuove doppio sfondo */
         box-shadow: none; /* Rimuove doppia ombra */
    }
    /* Stili specifici sfondi/bordi tipi sfida */
    .group-challenge.challenge-card { background: linear-gradient(135deg, #4a433a, #5a534a); border-color: var(--warning-color); } /* Dark Yellowish */
    .couple-challenge.challenge-card { background: linear-gradient(135deg, #3a4a5a, #4a5a6a); border-color: var(--couple-color); } /* Dark Bluish */
    .challenge-mode.challenge-card { background: linear-gradient(135deg, #4a3a5a, #5a4a6a); border-color: var(--challenge-color); } /* Dark Purplish */

    #challenge-image-container { display: none; margin-bottom: 15px; text-align: center; }
    #challenge-image { max-width: 90%; max-height: 200px; height: auto; width: auto; border-radius: 8px; display: inline-block; object-fit: contain; background-color: rgba(255,255,255,0.1); /* Leggero sfondo per immagini trasparenti */ }
    .players-pair { font-weight: 700; font-size: 1.3em; color: var(--text-main); margin-bottom: 15px; }
    /* Colori specifici header */
    .couple-challenge .players-pair { color: var(--couple-color); }
    .challenge-mode .players-pair { color: var(--challenge-color); }
    .group-challenge .players-pair { color: var(--warning-color); } /* Giallo/Arancio per Gruppo */
    /* Per 1vs1, usa il colore primario? */
     .challenge-card:not(.group-challenge):not(.couple-challenge):not(.challenge-mode) .players-pair {
         color: var(--primary-color); /* Rosso per 1vs1 */
     }

    .challenge-text { font-size: 1.35em; line-height: 1.5; color: var(--text-main); margin: 0; }

    /* Bottone Risate Generali */
    #general-laugh-btn { display: none; margin: 20px auto 0 auto; background-color: var(--accent-color); /* Verde Logo */ color: var(--bg-card); /* Testo scuro su verde */ padding: 10px 20px; font-size: 1em; }
    #general-laugh-btn:hover:not(:disabled) { background-color: var(--accent-dark); }

    /* Bottoni Controllo Gioco */
    .game-controls { margin-top: 20px; text-align: center; }
    #next-btn { background-color: var(--primary-color); color: white; }
    #next-btn:hover:not(:disabled) { background-color: var(--primary-dark); }
    .end-btn { background-color: var(--warning-color); color: var(--bg-card); } /* Testo scuro su giallo */
    .end-btn:hover { background-color: var(--warning-dark); }


     /* === SCOREBOARD SIDEBAR === */
     ul#scoreboard-list { list-style: none; padding: 0; margin: 0; }
     li.score-item {
        padding: 10px 12px; margin-bottom: 8px; border-radius: 8px;
        background-color: var(--bg-item); /* Grigio Item */
        display: flex; justify-content: space-between; align-items: center;
        transition: background-color 0.3s, box-shadow 0.3s;
     }
     li.score-item.highlight { background-color: var(--highlight-bg); box-shadow: 0 0 8px rgba(255, 255, 255, 0.2); }
     .score-name { font-weight: 600; flex-grow: 1; margin-right: 10px; color: var(--text-main); }
     .score-points { font-weight: 700; color: var(--text-secondary); margin-right: 10px;}
     .score-actions { display: none; gap: 8px; /* Aumentato gap */ }
     li.score-item.highlight .score-actions { display: flex; } /* Mostra se evidenziato */
     .score-actions button { background: none; border: none; padding: 0; cursor: pointer; font-size: 1.6em; /* Icone più grandi */ transition: transform 0.2s; display: none; /* Nascosti di default, mostrati da JS */}
     .score-actions button:hover { transform: scale(1.2); }
     /* Mostra specifici bottoni */
      li.score-item.highlight .like-btn, li.score-item.highlight .dislike-btn, li.score-item.highlight .vote-winner-btn { display: inline-block; }

     .like-btn { color: var(--like-color); }
     .dislike-btn { color: var(--dislike-color); }
     .vote-winner-btn { color: var(--vote-color); font-size: 1.4em; }
     .vote-winner-btn::before { content: '🏆'; margin-right: 0px; }


     /* Scoreboard Finale (Sinistra) */
      #scoreboard-section h2 { color: var(--secondary-color); font-size: 1.8em;}
      #scoreboard-section .score-list-final { width: 100%; text-align: left; }
      #scoreboard-section .score-item { background-color: var(--bg-item); box-shadow: var(--box-shadow-light); font-size: 1.1em; }
      #scoreboard-section .winner {
           background: var(--winner-bg); /* Giallo logo */
           font-weight: 700 !important;
           border: 2px solid var(--warning-dark);
           transform: scale(1.03);
           box-shadow: var(--box-shadow-medium);
           color: var(--bg-card); /* Testo scuro su sfondo oro/giallo */
      }
     #scoreboard-section .winner .score-name { color: var(--bg-card); }
     #scoreboard-section .winner .score-points { color: var(--primary-dark); /* Rosso scuro per contrasto su giallo */ font-size: 1.1em;}
     #scoreboard-section .game-controls { margin-top: 30px; }
     #scoreboard-section .game-controls button { background-color: var(--primary-color); color: white; } /* Bottone Nuova Partita */


     /* === RESPONSIVENESS (Minime modifiche necessarie) === */
     @media (max-width: 900px) {
        .main-layout { flex-direction: column; align-items: stretch; /* Allunga elementi */ }
        .scoreboard-sidebar { width: auto; max-width: none; position: static; margin-top: 20px; order: 2; flex-basis: auto; }
        .game-content { width: auto; max-width: none; order: 1; }
        body { padding: 15px; }
     }
      @media (max-width: 600px) {
          h1 { font-size: 2em; } /* Rimosso, non serve */
          .logo-container img { max-width: 240px; } /* Logo più piccolo */
          #setup-section, #game-section, #scoreboard-section { padding: 20px; }
          .input-group { flex-direction: column; align-items: stretch; }
          .input-group input, .input-group button { width: 100%; }
          button { padding: 12px 18px; font-size: 0.95em; }
          .challenge-card { padding: 20px; min-height: 250px; }
          #challenge-image { max-height: 150px; }
          .players-pair { font-size: 1.1em; }
          .challenge-text { font-size: 1.25em; }
          .scoreboard-sidebar { padding: 15px; }
          li.score-item { flex-wrap: wrap; padding: 8px 10px; }
          .score-actions { margin-top: 5px; width: 100%; justify-content: flex-end; }
          .score-actions button { font-size: 1.4em; }
          #scoreboard-section .score-item { font-size: 1em; padding: 10px 12px;}
          /* Adatta altri padding/font se necessario */
      }

</style>
  </head>
  <body>
    <div class="main-layout">
      <!-- Colonna Sinistra: Contenuto Gioco (Setup o Sfida) -->
    <div class="game-content">
    <div style="text-align: center; margin-bottom: 30px;"> <!-- Aumentato margin-bottom -->
         <img src="images/logo.png" alt="Logo Reazione a Cancrena" style="max-width: 300px; height: auto;"> <!-- Aumentato max-width -->
     </div>
  
        <!-- Sezione Setup (Inizialmente Visibile) -->
        <div id="setup-section">
          <h2>Crea la tua Squadra (e Coppie)</h2>
          <div class="input-group">
            <input
              type="text"
              id="player-name"
              placeholder="Nome giocatore..."
            />
            <button onclick="addPlayer()">Aggiungi</button>
          </div>
          <ul id="players-list"></ul>
          <div id="couple-section" style="display: none">
            <h3>Forma Coppie (Opzionale)</h3>
            <div class="couple-selectors">
              <div>
                <label for="couple-player1">Giocatore 1:</label>
                <select id="couple-player1">
                  <option value="">Seleziona...</option>
                </select>
              </div>
              <div>
                <label for="couple-player2">Giocatore 2:</label>
                <select id="couple-player2">
                  <option value="">Seleziona...</option>
                </select>
              </div>
            </div>
            <button id="couple-btn" onclick="formCouple()" disabled>
              Abbina Coppia
            </button>
          </div>
          <button onclick="startGame()" id="start-btn" disabled>
            Inizia Gioco
          </button>
        </div>

        <!-- Sezione Gioco (Inizialmente Nascosta) -->
        <div id="game-section">
          <div class="challenge-card" id="challenge-card">
            <!-- Contenuto dinamico sfida -->
            <div id="challenge-image-container">
              <img id="challenge-image" src="" alt="Immagine Sfida" />
            </div>
            <div class="players-pair" id="current-pair"></div>
            <div class="challenge-text" id="challenge-text"></div>
            <!-- Bottone Risate Generali (solo per gruppo) -->
            <button id="general-laugh-btn" onclick="assignGroupPoints()">
              RISATE GENERALI 🎉 (+1 a tutti)
            </button>
          </div>
          <!-- Controlli generali gioco -->
          <div class="game-controls">
            <button onclick="nextChallenge()" id="next-btn">
              Prossima Sfida
            </button>
            <button class="end-btn" onclick="endGame()">Termina Partita</button>
          </div>
        </div>

        <!-- Sezione Scoreboard Finale (Inizialmente Nascosta) -->
        <div id="scoreboard-section">
          <h2>Classifica Finale</h2>
          <div id="score-list-final" class="score-list-final">
            <!-- Contenuto generato da JS -->
          </div>
          <div class="game-controls">
            <button onclick="resetGame()">Nuova Partita</button>
          </div>
        </div>
      </div>

      <!-- Colonna Destra: Scoreboard Sidebar (Visibile durante gioco) -->
      <div
        class="scoreboard-sidebar"
        id="scoreboard-sidebar"
        style="display: none"
      >
        <!-- Nascosto finché il gioco non inizia -->
        <h2>Punteggi</h2>
        <ul id="scoreboard-list">
          <!-- Contenuto generato da JS -->
          <!-- Esempio Item (verrà clonato):
                <li class="score-item" data-player-name="NomeGiocatore">
                    <span class="score-name">NomeGiocatore</span>
                    <span class="score-points">0</span>
                    <div class="score-actions">
                        <button class="like-btn" title="Assegna Punto" onclick="assignPoints('NomeGiocatore', 'like')">👍</button>
                        <button class="dislike-btn" title="Nessun Punto" onclick="assignPoints('NomeGiocatore', 'dislike')">👎</button>
                        <button class="vote-winner-btn" title="Vincitore Sfida" onclick="assignPoints('NomeGiocatore', 'challengeWin')"> </button>
                    </div>
                </li>
                 -->
        </ul>
      </div>
    </div>

    <script>
      // -------- STATO DEL GIOCO --------
      let players = [];
      let couples = [];
      let playerScores = {};
      let currentChallengeData = null;

      // Probabilità
      const oneVsOneProbability = 45;
      const groupChallengeProbability = 20;
      const coupleChallengeProbability = 20;
      const challengeModeProbability = 15;
      // Punti
      const likePoints = 1;
      const dislikePoints = 0;
      const challengeWinPoints = 3;
      const groupLaughPoints = 1;

      // -------- ARRAY DELLE SFIDE --------
      // (Riutilizza gli array completi con le tue immagini dall'ultimo codice - omessi per brevità)
      const compliments = [
        {
          type: "text",
          text: "Se [PLAYER] fosse un colore, quale sarebbe e perché emana quella particolare 'vibrazione'?",
        },
        { type: "text", text: "Se [PLAYER] fosse una marca assurda di dentifricio, quale sarebbe il suo slogan?" },
  { type: "image", text: "Descrivi perché [PLAYER] ricorda l'energia positiva di questo Lama Fashionista.", image: "images/Lama_Fashionista.jpg" },
  { type: "text", text: "Fai un complimento a [PLAYER] immaginandolo come protagonista di un cartone animato giapponese surreale." },
        {
          type: "text",
          text: "Quale canzone descrive perfettamente l'energia o lo spirito di [PLAYER]?",
        },
        {
          type: "image",
          text: "Anche questo Gatto Kung Fu ha i suoi momenti di tenerezza. Fai a [PLAYER] un complimento sulla sua capacità nascosta di essere dolce o premuroso/a.",
          image: "images/Gatto_allungato_mossa_KungFu.jpg",
        },
        {
          type: "text",
          text: "Descrivi la voce di [PLAYER] usando solo nomi di cibi (es: 'vellutata come un budino', 'croccante come un biscotto', 'frizzante come l'acqua tonica').",
        },
        {
          type: "text",
          text: "Se l'aura di [PLAYER] avesse un odore, quale sarebbe (deve essere un odore piacevole ma strano, es: 'plastilina nuova e vaniglia', 'benzina e lavanda')?",
        },
        {
          type: "image",
          text: "Questo Asino Cartoon sembra confuso ma buono. Fai un complimento a [PLAYER] sulla sua genuinità o sulla sua incapacità di essere veramente cattivo/a.",
          image: "images/Asino_con_occhi_grandi_cartoon.jpg",
        },
        {
          type: "text",
          text: "Qual è la cosa più intelligentemente pigra che hai visto fare a [PLAYER] e che segretamente ammiri?",
        },
        {
          type: "image",
          text: "Questa Lontra Umana ([PLAYER]?) ha degli occhi penetranti. Fai un complimento sincero a [PLAYER] sul suo sguardo o sulla sua profondità.",
          image: "images/Lontra_umana_con_occhi_azzurri.jpg",
        },
        {
          type: "text",
          text: "Descrivi un piccolo gesto quasi invisibile di [PLAYER] che però trovi significativo.",
        },
        {
          type: "text",
          text: "Fai un complimento a [PLAYER] su una sua caratteristica fisica o di stile che ti piace.",
        },
        {
          type: "text",
          text: "Se [PLAYER] fosse un fenomeno atmosferico (sole, pioggia...), quale sarebbe e perché?",
        },
        {
          type: "image",
          text: "Nonostante la puzza, questo cane ha un suo perché. Trova un pregio 'nascosto' di [PLAYER] e descrivilo.",
          image: "images/un_cane_puzza.jpg",
        },
        {
          type: "text",
          text: "Fai un complimento sincero su una qualità del carattere che ammiri profondamente in [PLAYER].",
        },
        {
          type: "text",
          text: "Condividi qualcosa di concreto che hai imparato grazie a [PLAYER].",
        },
        {
          type: "text",
          text: "Descrivi [PLAYER] in tre aggettivi precisi (non banali!) e spiega la scelta.",
        },
        {
          type: "image",
          text: "Questo Gatto Kung Fu ha stile. Fai un complimento a [PLAYER] sulla sua agilità (fisica o mentale) o sul suo stile unico.",
          image: "images/Gatto_allungato_mossa_KungFu.jpg",
        },
        {
          type: "text",
          text: "Se [PLAYER] fosse un piatto gourmet, quali ingredienti conterrebbe e perché?",
        },
        {
          type: "text",
          text: "Descrivi l'aura di [PLAYER] usando solo colori e sensazioni tattili.",
        },
        {
          type: "text",
          text: "Se [PLAYER] potesse essere un elemento architettonico di un edificio storico, quale sarebbe e perché?",
        },
        {
          type: "text",
          text: "Se [PLAYER] fosse un profumo, quali note avrebbe e in quale situazione sarebbe perfetto indossarlo?",
        },
        {
          type: "text",
          text: "Quale superpotere segreto pensi abbia [PLAYER] nella vita quotidiana?",
        },
        {
          type: "text",
          text: "Quale animale mitologico rappresenta meglio l'essenza di [PLAYER] e perché?",
        },
        {
          type: "text",
          text: "Descrivi un talento nascosto che [PLAYER] potrebbe avere ma che non ha ancora rivelato al mondo.",
        },
        {
          type: "text",
          text: "Se [PLAYER] fosse un pianeta del nostro sistema solare, quale sarebbe e perché si adatta alla sua personalità?",
        },
      ];
      const roasts = [
        {
          type: "text",
          text: "Se [PLAYER] fosse un meme famoso, quale sarebbe?",
        },
        { type: "text", text: "Se [PLAYER] fosse una pizza, quale topping assolutamente discutibile avrebbe e perché?" },
  { type: "image", text: "Ammettilo, questo Pinguino Impacciato è la rappresentazione perfetta di [PLAYER] mentre cerca di sembrare cool.", image: "images/Pinguino_impacciato.jpg" },
  { type: "text", text: "Descrivi il talento segreto di [PLAYER] che nessuno vorrebbe mai avere." },
        {
          type: "image",
          text: "Questa immagine è chiaramente [PLAYER] al mattino prima del caffè. Confermi? Motiva il roast.",
          image: "images/Shrek_con_sorriso_memico.jpg",
        },
        {
          type: "text",
          text: "Quale oggetto inanimato in questa stanza assomiglia di più (caratterialmente) a [PLAYER]? Spiega il perché.",
        },
        {
          type: "image",
          text: "Se [PLAYER] dovesse dare un nome 'epico' a questo Cane Stupito, quale sarebbe e perché si addice a entrambi?",
          image: "images/Cane_con_faccia_stupita_e_sproporzionata.jpg",
        },
        {
          type: "text",
          text: "[PLAYER] viene morso da un ragno radioattivo. Quale superpotere TOTALMENTE INUTILE ottiene (es: 'sentire il sapore dei colori', 'parlare con i semafori spenti')?",
        },
        {
          type: "text",
          text: "Imita il modo in cui [PLAYER] cammina quando pensa di essere figo/a ma in realtà sembra solo strano.",
        },
        {
          type: "image",
          text: "Quale frase tipica di [PLAYER] si abbinerebbe perfettamente a questa immagine dell'Uomo-Baffo?",
          image: "images/Uomo_con_baffi_filter_volto_allungato.jpg",
        },
        {
          type: "text",
          text: "Se dovessi riassumere l'essenza di [PLAYER] con un rumore di notifica del telefono, quale sarebbe?",
        },
        {
          type: "image",
          text: "Ammettilo, l'espressione di questo Asino non ti ricorda *perfettamente* [PLAYER] quando è confuso/a?",
          image: "images/Asino_con_occhi_grandi_cartoon.jpg",
        },
        {
          type: "text",
          text: "Qual è il superpotere più gloriosamente inutile che [PLAYER] potrebbe possedere?",
        },
        {
          type: "text",
          text: "Chiedi a [PLAYER]: 'Da 1 a 10, quanto ti senti 'Mr. Carrot' oggi?' Spiega il punteggio.",
          image: "images/Mr_Carrot_testa_umanoide_conici.jpg",
        },
        {
          type: "image",
          text: "Questa Arancia con faccia di scimmia è chiaramente l'animale spirituale di [PLAYER]. Concordi? Motiva.",
          image: "images/Arancia_con_faccia_di_scimmia.jpg",
        },
        {
          type: "text",
          text: "Descrivi la 'modalità Autopilot' di [PLAYER]: cosa fa quando sembra disconnesso?",
        },
        {
          type: "image",
          text: "Se [PLAYER] dovesse usare questa faccia da casa arrabbiata per spaventare qualcuno, funzionerebbe?",
          image: "images/Casa_con_faccia_umano_arrabbiato.jpg",
        },
        {
          type: "text",
          text: "Traduci la risata di [PLAYER] in un suono onomatopeico strano.",
        },
        {
          type: "image",
          text: "Questo è [PLAYER] dopo una serata impegnativa, vero?",
          image: "images/woody_strafatto.jpg",
        },
        {
          type: "text",
          text: "Fai un roast *gentile* a [PLAYER] su un suo difettuccio, ma poi smorza con un complimento.",
        },
        {
          type: "text",
          text: "Imita (senza cattiveria!) un'espressione facciale o un gesto tipico di [PLAYER].",
        },
        { type: 'text', text: "Quale sarebbe il 'bug' più fastidioso se [PLAYER] fosse un personaggio di un videogioco?" },
        { type: 'text', text: "Descrivi il peggior incubo di [PLAYER] usando solo 5 parole." },
        {
          type: "image",
          text: "L'urlo di questo Ippopotamo è come quello di [PLAYER] quando... (completa la frase)",
          image: "images/Ippopotamo_gridante_su_sfondo_giallo.jpg",
        },
        {
          type: "image",
          text: "Onestamente, [PLAYER], quanto ti senti rappresentato/a da questo Gatto Vampiro?",
          image: "images/Gatto_arrabbiato_con_denti_da_vampiro.jpg",
        },
        {
          type: "text",
          text: "Se [PLAYER] fosse un elettrodomestico malfunzionante, quale sarebbe e cosa farebbe di strano?",
        },
        
        {
          type: "text",
          text: "Descrivi [PLAYER] come se fosse la peggiore recensione a 1 stella di un ristorante di lusso.",
        },
        {
          type: "text",
          text: "Se la postura di [PLAYER] potesse parlare, quale frase ripeterebbe continuamente?",
        },
        {
          type: "text",
          text: "Quale emoji descrive meglio la faccia di [PLAYER] quando cerca di sembrare intelligente?",
        },
        {
          type: "text",
          text: "Se la vita di [PLAYER] fosse un film di serie B, quale sarebbe il titolo e la trama assurda?",
        },
        {
          type: "text",
          text: "Se lo stile di [PLAYER] fosse un piatto di cucina fusion andato male, quali ingredienti incompatibili conterrebbe?",
        },
        {
          type: "text",
          text: "Quale trend di TikTok ormai superato [PLAYER] probabilmente segue ancora in segreto?",
        },
      ];
      const uncomfortableQuestions = [
        {
          type: "image",
          text: "[PLAYER], fissa questo ciccione viola per 10 secondi. Ora confessa il primo pensiero *veramente* assurdo che ti è venuto.",
          image: "images/Alieno_viola_in_foresta_fluorescente.jpg",
        },
        { type: "text", text: "[PLAYER], preferiresti essere seguito/a costantemente da un mariachi band o da un clown triste?" },
 
  { type: "text", text: "[PLAYER], devi confessare la canzone più imbarazzante che hai cantato a squarciagola sotto la doccia." },
        {
          type: "text",
          text: "[PLAYER], descrivi al gruppo, con un livello di dettaglio quasi chirurgico (ma senza volgarità gratuita!), la tua procedura ESATTA per lavarti i piedi. Non saltare passaggi.",
        },
        {
          type: "text",
          text: "[PLAYER], devi raccontarci una cosa assolutamente normale e banale che hai fatto oggi (es: versare l'acqua). Raccontala nel modo più piatto e noioso possibile. L'obiettivo è *non* far ridere.",
        },
        {
          type: "text",
          text: "[PLAYER], qual è quella cosa *veramente* strana o super specifica che pensi faccia ridere solo te? Confessala e prova a spiegare perché.",
        },
        {
          type: "text",
          text: "[PLAYER], scenario assurdo: sei all'Eurospin. Quale attore/attrice italiano/a completamente fuori luogo vorresti trovare lì come commesso/a e perché?",
        },
        {
          type: "text",
          text: "[PLAYER], onestamente, che tipo specifico di scarpa ti senti di essere in questo momento della tua vita (es: 'ciabatta consumata', 'stivale rotto', 'calzino antiscivolo')? Motiva.",
        },
        {
          type: "text",
          text: "[PLAYER], come si chiama il parroco della tua parrocchia/zona? (Se non lo sai, puoi dire 'Passo' o inventare).",
        }, // Attenzione: potenzialmente sensibile
       
        {
          type: "text",
          text: "[PLAYER], preferiresti avere un terzo braccio che spunta dalla schiena o non avere più le ginocchia?",
        },
       
        {
          type: "image",
          text: "[PLAYER], confessa: quanto spesso ti senti come questo Ippopotamo urlante interiormente durante una normale giornata lavorativa/scolastica?",
          image: "images/Ippopotamo_gridante_su_sfondo_giallo.jpg",
        },
        {
          type: "text",
          text: "[PLAYER], se la tua vita fosse un film, quale sarebbe il titolo più brutalmente onesto?",
        },
        {
          type: "image",
          text: "Fissa l'Uovo con gli occhiali per 5 secondi. Ora [PLAYER], chiudi gli occhi e descrivi la prima forma geometrica che ti viene in mente.",
          image: "images/Uovo_con_occhiali_e_volto_umano.jpg",
        },
        {
          type: "text",
          text: "[PLAYER], quale sarebbe la tua frase celebre se fossi il cattivo in un film di serie B?",
        },
        {
          type: "text",
          text: "Devi eliminare per sempre una delle seguenti cose dalla tua vita: la pizza o la musica. Cosa scegli, [PLAYER]?",
        },
        {
          type: "image",
          text: "Questo Mr. Carrot è il tuo spirito guida o il tuo peggior incubo, [PLAYER]?",
          image: "images/Mr_Carrot_testa_umanoide_conici.jpg",
        },
        {
          type: "text",
          text: "[PLAYER], domanda fondamentale: che tipo di elettrodomestico ti senti OGGI e perché?",
        },
         {
          type: "text",
          text: "[PLAYER], qual è il tuo albero preferito?",
        },
         {
          type: "text",
          text: "[PLAYER], qual è il personaggio storico che ti viene in mente quando fai la cacca?",
        },
         {
          type: "text",
          text: "[PLAYER], hai mai pensato a quanto sono belli i treni?",
        },
         {
          type: "text",
          text: "[PLAYER], qual è la tua espressione facciale preferita?",
        },
         {
          type: "text",
          text: "[PLAYER], hai mai urlato contro il pane?",
        },
         {
          type: "text",
          text: "[PLAYER], hai mai pensato di farti il bagno a mare con i calzini di spugna? Se no, prova, poi mi fai sapere.",
        },
         {
          type: "text",
          text: "[PLAYER], se la tua macchina potesse parlare cosa ti direbbe? Se non hai una macchina allora le scarpe.",
        },
        
        {
          type: "text",
          text: "[PLAYER], quale specifica ora NON ESISTENTE del giorno (es: le 25:77) ti senti in questo momento e perché?",
        },
        {
          type: "image",
          text: "Questa immagine rappresenta [PLAYER] quando cerca di spiegare qualcosa di complicato? Siate sinceri.",
          image: "images/Uomo_con_baffi_filter_volto_allungato.jpg",
        },
       { type: "text", text: "[PLAYER],crea una frase per questo meme famoso", image: "Gigachad.jpg", },
        {
          type: "text",
          text: "Chiedi a [PLAYER]: 'Hai mai cagato in discoteca? Inteso come posto peggiore / momento peggiore dove aver fatto la cacca'",
        },
        {
          type: "image",
          text: "Questa Maschera Inquietante è come ti immagini la coscienza di [PLAYER]? Spiega.",
          image: "images/Maschera_bianca_inquietante_su_uomo.jpg",
        },
        {
          type: "text",
          text: "[PLAYER], preferiresti essere ricercato dalla polizia o da una pericolosa organizzazione criminale?",
        },
        {
          type: "text",
          text: "Chiedi a [PLAYER]: 'Qual è il pensiero più socialmente inaccettabile (ma che non diresti mai) che hai avuto guardando un reality show?'",
        },
        {
          type: "image",
          text: "[MITTENTE], [PLAYER] sarebbe più l'Omino Grasso o il suo destriero invisibile?",
          image: "images/Omino_grasso_stile_cartoon_in_armatura.jpg",
        }, // Modificata
        {
          type: "image",
          text: "[MITTENTE], cosa ne pensa [PLAYER] di questa Scimmia con caschetto?",
          image: "images/Scimmia_caschetto_stile_moderno.jpg",
        }, // Modificata
        {
          type: "text",
          text: "Confessa una piccola bugia bianca (o non così bianca) che hai detto a [PLAYER] per evitare di fare qualcosa.",
        },
        {
          type: "text",
          text: "Devi dire a [PLAYER] una verità scomoda ma costruttiva sul suo profilo social preferito.",
        },
        {
          type: "text",
          text: "Fai una domanda super personale a [PLAYER] (può usare un jolly e non rispondere, ma deve subire una piccola penitenza decisa dal gruppo).",
        },
        {
          type: "text",
          text: "[PLAYER], in una scala da 1 a 10, quanto consideri discutibile la tua ultima decisione importante? Spiega.",
        },
        {
          type: "text",
          text: "[PLAYER], se potessi creare una legge assurda ma che tutti devono seguire, quale sarebbe e perché?",
        },
        {
          type: "text",
          text: "[PLAYER], se i tuoi amici qui presenti creassero un documentario sulla tua vita, quale sarebbe il titolo più imbarazzante ma accurato?",
        },
        {
          type: "text",
          text: "[PLAYER], qual è la cosa più strana che hai cercato su Google o chatgpt nell'ultima settimana che non vorresti che gli altri sapessero?",
        },
        {
          type: "text",
          text: "[PLAYER], se il tuo animale domestico (o un oggetto in casa tua) potesse parlare, quale segreto imbarazzante rivelerebbe su di te?",
        },
        {
          type: "text",
          text: "[PLAYER], considerando i presenti, chi chiameresti alle 3 del mattino per aiutarti a nascondere un pinguino rubato dallo zoo? E perché?",
        },
        {
          type: "text",
          text: "[PLAYER], se i tuoi DM/messaggi privati venissero esposti pubblicamente, quale sarebbe la conversazione che ti metterebbe più in imbarazzo?",
        },
        {
          type: "text",
          text: "[PLAYER], quale serie o film ti vergogni segretamente di amare ma difenderesti con passione se qualcuno lo criticasse?",
        },
      ];
      const groupChallenges = [
        {
          type: "image",
          text: "Gruppo: chi qui dentro è più probabile che abbia un poster di *questo* in camera?",
          image: "images/Vecchia_baldracca.jpg",
        },
        { type: "text", text: "Gruppo: create una pubblicità TV improvvisata per vendere qualcosa di completamente inutile (es: 'pantofole per le mani')." },
  { type: "image", text: "Tutti imitano contemporaneamente la posa epica di questa Tartaruga Ninja Depressa.", image: "images/Tartaruga_ninja_depressa.jpg" },
  { type: "text", text: "Gruppo: a turno, inventate una nuova parola assurda e datele un significato strano." },
        {
          type: "image",
          text: "TUTTI: guardate attentamente quest'immagine dell'Uomo-Delfino. Al 'VIA!' del GM, dovete scatenare il vostro urlo di puro terrore più convincente.",
          image: "images/UOMO_FACCIA_DELFINO.jpg",
        }, // NOME FILE DA VERIFICARE
        {
          type: "text",
          text: "TUTTI (o i più coraggiosi): cantate insieme A CAPPELA il ritornello di 'My Heart Will Go On'. Metteteci sentimento!",
        },
        {
          type: "text",
          text: "Momento Orchestra Corporea: a turno, ogni giocatore deve fare un suono corporeo (schiocco dita, battito mani, pernacchia...) cercando di creare un ritmo collettivo assurdo.",
        },
         {
          type: "text",
          text: "Il più alto della stanza deve farsi una foto accanto al più basso della stanza.",
        },
         {
          type: "text",
          text: "Chi ha pubblicato l'ultima storia su instagram più divertente vince un materasso Eminflex®.",
        },
         {
          type: "text",
          text: "L'ultimo che ha aggiornato la foto profilo su Facebook verrà chiamato vecchio per il resto del gioco ed interagirete con lui come se fosse un nonno/a che non ci sente.",
        },
        
        {
          type: "text",
          text: "A turno, ogni giocatore deve dire una parola. L'obiettivo è creare collettivamente una frase di senso compiuto più lunga possibile, ma che sia completamente idiota.",
        },
        {
          type: "image",
          text: "Tutti insieme, come ci è finito questo ciccione viola nell'acqua? Spiegamelo perchè veramente non riesco a capire.",
          image: "images/Alieno_viola_in_foresta_fluorescente.jpg",
        },
        {
          type: "text",
          text: "Gioco del Sinonimo Improbabile: il GM dice una parola normale (es: 'felice'). A turno, dite un sinonimo sempre più strano e meno attinente (es: 'contento', 'gaio', 'pimpante', 'spumeggiante', 'fotosintetico'...). Chi esita o ripete è fuori (metaforicamente).",
        },
        {
          type: "image",
          text: "Tutti i giocatori devono camminare per la stanza imitando l'andatura fiera di questo Omino in Armatura.",
          image: "images/Omino_grasso_stile_cartoon_in_armatura.jpg",
        },
        {
          type: "text",
          text: "Ogni giocatore deve scegliere un altro giocatore e sussurrargli all'orecchio un complimento VERAMENTE imbarazzante. Le reazioni saranno giudicate!",
        },
        {
          type: "image",
          text: "Mostrate l'ultimo meme che avete ricevuto o inviato (i vostri nudes non contanto come meme).",
        },
        {
          type: "image",
          text: "Gruppo: questa immagine rappresenta l'umore medio di chi quando si sveglia? Votate!",
          image: "images/mood_mattutino.jpg",
        },
        {
          type: "text",
          text: "Gioco della sedia: un giocatore volontario dice che sedia si sente. Gli altri devono assegnargliene una più adatta.",
        },
        {
          type: "image",
          text: "Gruppo: assegnate il verso che farebbe questa chincillà umano.",
          image: "images/Lontra_umana_con_occhi_azzurri.jpg",
        },
        {
          type: "text",
          text: "Round di 'Obbligo o Verità' per un volontario. Il gruppo sceglie per lui/lei.",
        },
        {
          type: "image",
          text: "Gruppo: inventate collettivamente un titolo clickbait per un articolo sulla vita segreta di questo Gatto Vampiro.",
          image: "images/Gatto_arrabbiato_con_denti_da_vampiro.jpg",
        },
        {
          type: "text",
          text: "Complimento competitivo per un volontario: chi fa il complimento più originale vince.",
        },
        {
          type: "image",
          text: "Gruppo: descrivete come parlerebbe questo cane.",
          image: "images/Cane_con_faccia_stupita_e_sproporzionata.jpg",
        },
        {
          type: "image",
          text: "Tutti: imitate l'espressione di Shrek ora!",
          image: "images/Shrek_con_sorriso_memico.jpg",
        },
        {
          type: "text",
          text: "Domanda Trivia su un giocatore scelto a caso: chi risponde correttamente per primo vince.",
        },
        {
          type: "text",
          text: "Gruppo: ognuno faccia la sua migliore imitazione del suono di avvio di un vecchio computer Windows. I presenti votano la più realistica.",
        },
        {
          type: "text",
          text: "Gruppo: create collettivamente una ricetta di cucina usando solo oggetti visibili nella stanza. Più assurda è, meglio è!",
        },
        {
          type: "text",
          text: "Gruppo: catena di battute pessime - qualcuno inizia con una battuta davvero terribile, e a turno ognuno deve farne una peggiore della precedente.",
        },
        {
          type: "text",
          text: "Gruppo: ognuno deve inventare un soprannome ridicolo per la persona alla propria destra, basato su un incidente imbarazzante (reale o immaginario).",
        },
        {
          type: "text",
          text: "Gruppo: imitazione rapida - un volontario fa un gesto o un'espressione bizzarra, e tutti devono immediatamente copiarla il più accuratamente possibile.",
        },
        {
          type: "text",
          text: "Gruppo: create un breve telegiornale assurdo dove ogni persona aggiunge una notizia sempre più surreale, collegandola alla precedente.",
        },
        {
          type: "text",
          text: "Gruppo: inventate una danza di gruppo improbabile chiamata 'La Cancrena'. Ogni persona aggiunge un movimento e alla fine eseguitela tutti insieme.",
        },
        {
          type: "text",
          text: "Gruppo: date vita a un tribunale improvvisato dove si processa un oggetto presente nella stanza per crimini ridicoli. Assegnate i ruoli di giudice, accusa, difesa e testimoni.",
        },
      ]; // Rimosso [PLAYER=mittente]
      const coupleChallenges = [
        {
          type: "text",
          text: "Coppia ([COPPIA_1] & [COPPIA_2]): chi di voi due è più probabile che pianga guardando un cartone?",
        },
        
        {
          type: "text",
          text: "Coppia ([COPPIA_1] & [COPPIA_2]): descrivete a turno il partner usando solo rumori di animali. L'altro deve indovinare l'animale (e l'intenzione).",
        },
        {
          type: "image",
          text: "Coppia: chi dei due assomiglia di più a quest'Arancia con faccia di scimmia quando prova a fare il/la simpatico/a?",
          image: "images/Arancia_con_faccia_di_scimmia.jpg",
        },
        {
          type: "text",
          text: "Coppia: se foste bloccati su un'isola deserta, chi dei due sarebbe il capo e chi il suddito (o il pasto)? Giustificate.",
        },
        {
          type: "text",
          text: "Coppia: unite i vosti nomi e cognomi per creare un essere mitologico. (tipo mario rossi e francesca esposito digievolve in Mariesca Espositossi) ",
        },
        {
          type: "text",
          text: "Coppia: qual è la cosa più irritante che il vostro partner fa MA che trovate segretamente adorabile?",
        },
        { type: "text", text: "Coppia: inventate una scena da film romantico ma recitatela in stile soap opera anni '80." },
  { type: "image", text: "Coppia: chi dei due si identifica di più con questo Bradipo Filosofico dopo una discussione?", image: "images/Bradipo_filosofico.jpg" },
  { type: "text", text: "Coppia: quale sarebbe il vostro nome combinato se foste una boyband o girlband di scarso successo?" },
        {
          type: "text",
          text: "Coppia: dovete scambiarvi i ruoli per 1 minuto. Imitate il modo di parlare e le manie tipiche del partner.",
        },
       
        {
          type: "text",
          text: "Coppia: chi dei due è più probabile che inizi a ballare da solo/a in cucina mentre prepara la cena?",
        },
     
        {
          type: "text",
          text: "Coppia: qual è la vostra 'canzone da disagio' segreta (quella che ascoltate ma vi vergognate un po')?",
        },
        {
          type: "text",
          text: "Inventate un nuovo gusto di pizza ispirato alla vostra relazione (es: 'Litigio e Riconciliazione al Gorgonzola', 'Passione e salsiccia').",
        },
        {
          type: "image",
          text: "Coppia: questa immagine rappresenta la vostra domenica tipo? Siate onesti!",
          image: "images/relax_o_caos.jpg",
        },
        {
          type: "text",
          text: "Coppia: qual è il nomignolo più imbarazzante che usate tra voi?",
        },
        {
          type: "image",
          text: "Coppia: l'acconciatura di questa Scimmia è l'aspirazione segreta di chi dei due?",
          image: "images/Scimmia_caschetto_stile_moderno.jpg",
        },
        {
          type: "text",
          text: "Coppia: descrivete il partner ideale per l'altro/a usando solo nomi di personaggi dei cartoni.",
        },
        {
          type: "image",
          text: "Coppia: la faccia di questo cane rappresenta chi dei due dopo una lunga giornata?",
          image: "images/un_cane_puzza.jpg",
        },
        {
          type: "text",
          text: "Coppia: se foste un gusto di pizza combinato, quale sarebbe?",
        },
        {
          type: "text",
          text: "Coppia: chi dei due è più bravo/a a mentire? L'altro/a deve fornire una prova (aneddoto).",
        },
        {
          type: "image",
          text: "Coppia: chi dei due esagera di più nel raccontare storie, come suggerisce questo Uomo?",
          image: "images/Uomo_con_baffi_filter_volto_allungato.jpg",
        },
        {
          type: "text",
          text: "Coppia: inventate e mostrate un ballo di coppia segreto e imbarazzante.",
        },
        {
          type: "image",
          text: "Coppia: guardate l'Uovo. Senza parlare, indicate chi dei due è più 'secchione'.",
          image: "images/Uovo_con_occhiali_e_volto_umano.jpg",
        },
        {
          type: "text",
          text: "Coppia: chi è il più fortunato fra voi due? (parlo di fortuna intesa come colpo di fortuna, chi trova parcheggio subito, trova i soldi a terra ecc ecc.",
        },
        {
          type: "text",
          text: "Coppia ([COPPIA_1] & [COPPIA_2]): create un nuovo supereroe combinando i vostri 'poteri' e difetti peggiori. Come si chiama e quale sarebbe il suo costume?",
        },
        {
          type: "text",
          text: "Coppia: improvvisate una breve scena da telenovela drammatica dove uno di voi ha appena scoperto che l'altro è il suo gemello segreto.",
        },
        {
          type: "text",
          text: "Coppia: create una pubblicità per un prodotto assurdo che risolve un problema che solo voi due avete, alternandovi nelle frasi senza consultarvi prima.",
        },
        {
          type: "text",
          text: "Coppia: intervista assurda - uno fa domande totalmente random, l'altro deve rispondere seriamente come se fosse un esperto mondiale dell'argomento.",
        },
        {
          type: "text",
          text: "Coppia: dovete descrivere la giornata tipo dell'altro come se fosse un documentario di National Geographic sulle strane abitudini di una specie rara.",
        },
        {
          type: "text",
          text: "Coppia: chi ha inviato l'ultimo nudino.",
        },
        {
          type: "text",
          text: "Coppia: inventate una nuova festa nazionale basata sulle vostre personalità combinate. Quali sarebbero le tradizioni e i rituali di questa festa?",
        },
        {
          type: "text",
          text: "Coppia: dovete farvi a vicenda complimenti assurdamente specifici nello stile di un poeta drammatico dell'800. Chi fa il complimento più elaborato vince.",
        },
      ]; // Rimosso [MITTENTE]
      const challengeModeChallenges = [
        /* ...identici a prima... */ {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: sfida a chi imita meglio il suono di un modem 56k che si connette.",
        },{ type: "text", text: "[PLAYER_1] e [PLAYER_2]: sfida a chi imita meglio una stampante bloccata che tenta disperatamente di stampare." },
  { type: "image", text: "[PLAYER_1] vs [PLAYER_2]: Chi riesce a imitare meglio l'intensità drammatica di questo Scoiattolo Eroico?", image: "images/Scoiattolo_eroico.jpg" },
  { type: "text", text: "[PLAYER_1] e [PLAYER_2]: sfida di improvvisazione - chi racconta la storia più convincente di un'invasione aliena assurda?" },
        {
          type: "text",
          text: "[PLAYER_1] vs [PLAYER_2]: Gara di Rutti Mentali. Chi riesce a mimare il rutto più impressionante senza fare rumore?",
        },
        {
          type: "image",
          text: "[PLAYER_1] vs [PLAYER_2]: Imitate l'espressione di terrore esistenziale di quest'Uovo con gli occhiali. Il più convincente vince.",
          image: "images/Uovo_con_occhiali_e_volto_umano.jpg",
        },
        {
          type: "text",
          text: "[PLAYER_1] vs [PLAYER_2]: Sfida a chi inventa la scusa più assurda e incredibile per non andare a un matrimonio.",
        },
        {
          type: "image",
          text: "[PLAYER_1] vs [PLAYER_2]: Chi riesce a rimanere serio più a lungo guardando fisso questo Cane?",
          image: "images/Cane_con_faccia_stupita_e_sproporzionata.jpg",
        },
        {
          type: "text",
          text: "[PLAYER_1] vs [PLAYER_2]: Sfida di Mimo Veloce. Il GM sussurra un oggetto strano a entrambi, chi lo mima meglio e più velocemente per farlo indovinare al gruppo vince.",
        },
        {
          type: "text",
          text: "[PLAYER_1] vs [PLAYER_2]: Gara a chi pronuncia più velocemente e correttamente la frase 'Trentatré trentini entrarono a Trento tutti e trentatré trotterellando'.",
        },
        // Immagine riferimento 1
        // { type: 'image', image: "images/Uomo_con_baffi_filter_volto_allungato.jpg"} // Immagine riferimento 2 - complesso da mostrare, forse meglio evitarlo o descrivere il secondo personaggio.
        {
          type: "text",
          text: "[PLAYER_1] vs [PLAYER_2]: Sfida a chi riesce a fare il maggior numero di flessioni... con un solo dito (anche mimandole) in 10 secondi.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: dovete fare braccio di ferro mentale. Fissatevi intensamente finché uno dei due non ride o distoglie lo sguardo. Vietato toccarsi.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: sfida di sguardi assassini. Chi mantiene lo sguardo più minaccioso per 15 secondi vince.",
        },
        {
          type: "image",
          text: "[PLAYER_1] e [PLAYER_2]: chi dei due riesce a imitare meglio la posa di questo Gatto? Il gruppo giudica.",
          image: "images/Gatto_allungato_mossa_KungFu.jpg",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: gara a chi racconta la barzelletta più squallida e imbarazzante.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: sfida a chi riesce a stare in equilibrio su una gamba sola per più tempo (senza appoggiarsi!).",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: sfida a chi fa il verso di animale più strano e inaspettato.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: gara di complimenti passivo-aggressivi. Chi riesce a farne uno più tagliente ma velato vince.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: dovete recitare la scena madre di un film famoso ma usando solo la parola 'Cancrena'.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: gara a chi riesce a ridere in modo più malvagio e inquietante. Il gruppo decide il vincitore.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: sfida di beatbox improvvisato - ciascuno ha 15 secondi per creare il ritmo più assurdo possibile.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: dovete improvvisare un rap battle usando solo parole che iniziano con la prima lettera del nome dell'avversario.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: sfida delle espressioni facciali - mostrate la vostra migliore faccia da 'ho appena morso un limone mentre ricevo una multa'.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: sfida di mimo - interpretate l'emozione 'delusione cosmica' usando solo il vostro corpo, senza fare alcun suono.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: gara a chi inventa la scusa più assurda per non aver fatto i compiti, come se parlaste con un insegnante severo.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: sfida di danza assurda - dovete ballare nello stile di un animale improbabile (un bradipo, un granchio, ecc.). Il gruppo vota il migliore.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: vi sfido a cantare il titolo di una canzone famosa con l'accento più strano possibile. Gli altri devono indovinare la canzone.",
        },
      ];

      // -------- FUNZIONI UI e SETUP --------
      // (createScoreboardItem, updatePlayerScoreVisual, updateScoreboardSidebar - invariate rispetto all'ultima versione)
      function createScoreboardItem(playerName) {
        const li = document.createElement("li");
        li.className = "score-item";
        li.dataset.playerName = playerName;
        const nameSpan = document.createElement("span");
        nameSpan.className = "score-name";
        nameSpan.textContent = playerName;
        const pointsSpan = document.createElement("span");
        pointsSpan.className = "score-points";
        pointsSpan.textContent = "0";
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "score-actions";
        actionsDiv.style.display = "none";
        const likeBtn = document.createElement("button");
        likeBtn.className = "like-btn";
        likeBtn.title = "Assegna Punto (+1)";
        likeBtn.innerHTML = "👍";
        likeBtn.style.display = "none";
        likeBtn.onclick = (event) => {
          event.stopPropagation();
          assignPoints(playerName, "like");
        };
        actionsDiv.appendChild(likeBtn);
        const dislikeBtn = document.createElement("button");
        dislikeBtn.className = "dislike-btn";
        dislikeBtn.title = "Nessun Punto";
        dislikeBtn.innerHTML = "👎";
        dislikeBtn.style.display = "none";
        dislikeBtn.onclick = (event) => {
          event.stopPropagation();
          assignPoints(playerName, "dislike");
        };
        actionsDiv.appendChild(dislikeBtn);
        const voteBtn = document.createElement("button");
        voteBtn.className = "vote-winner-btn";
        voteBtn.title = "Vincitore Sfida!";
        voteBtn.innerHTML = "";
        voteBtn.style.display = "none";
        voteBtn.onclick = (event) => {
          event.stopPropagation();
          assignPoints(playerName, "challengeWin");
        };
        actionsDiv.appendChild(voteBtn);
        li.appendChild(nameSpan);
        li.appendChild(pointsSpan);
        li.appendChild(actionsDiv);
        return li;
      }
      function updateScoreboardSidebar() {
        const scoreboardList = document.getElementById("scoreboard-list");
        scoreboardList.innerHTML = "";
        players.forEach((player) => {
          const scoreItem = createScoreboardItem(player);
          scoreboardList.appendChild(scoreItem);
          updatePlayerScoreVisual(player);
        });
      }
      function updatePlayerScoreVisual(playerName) {
        const scoreItem = document.querySelector(
          `#scoreboard-list .score-item[data-player-name="${playerName}"]`
        );
        if (scoreItem) {
          const pointsSpan = scoreItem.querySelector(".score-points");
          if (pointsSpan) {
            pointsSpan.textContent =
              playerScores[playerName] !== undefined
                ? playerScores[playerName]
                : 0;
          }
        }
      }

      // --- Funzioni Setup Giocatori/Coppie (invariate) ---
      function addPlayer() {
        const playerNameInput = document.getElementById("player-name");
        const playerName = playerNameInput.value.trim();
        if (playerName && !players.includes(playerName)) {
          players.push(playerName);
          playerScores[playerName] = 0;
          updatePlayersList();
          /* updateScoreboardSidebar viene chiamata da updatePlayersList */ playerNameInput.value =
            "";
          document.getElementById("start-btn").disabled = players.length < 2;
          updateCoupleSectionVisibility();
        } else if (players.includes(playerName)) {
          alert("Questo giocatore esiste già!");
        }
        playerNameInput.focus();
      }
      function removePlayer(index) {
        const playerName = players[index];
        const wasInCouple = isPlayerInCouple(playerName);
        players.splice(index, 1);
        delete playerScores[playerName];
        if (wasInCouple) {
          couples = couples.filter((couple) => !couple.includes(playerName));
        }
        updatePlayersList();
        /* updateScoreboardSidebar viene chiamata da updatePlayersList */ document.getElementById(
          "start-btn"
        ).disabled = players.length < 2;
        updateCoupleSectionVisibility();
      }
      function updatePlayersList() {
        const playersListElement = document.getElementById("players-list");
        playersListElement.innerHTML = "";
        players.forEach((player, index) => {
          const li = document.createElement("li");
          li.className = "player-item";
          const nameSpan = document.createElement("span");
          nameSpan.className = "player-name";
          nameSpan.textContent = player;
          li.appendChild(nameSpan);
          const actionsDiv = document.createElement("div");
          actionsDiv.className = "player-actions";
          const coupleIconSpan = document.createElement("span");
          coupleIconSpan.className = "couple-icon";
          actionsDiv.appendChild(coupleIconSpan);
          const uncoupleBtn = document.createElement("button");
          uncoupleBtn.className = "uncouple-btn";
          uncoupleBtn.textContent = "Separa";
          uncoupleBtn.onclick = () => uncouplePlayers(player);
          actionsDiv.appendChild(uncoupleBtn);
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete-btn";
          deleteBtn.textContent = "Rimuovi";
          deleteBtn.onclick = () => removePlayer(index);
          actionsDiv.appendChild(deleteBtn);
          li.appendChild(actionsDiv);
          playersListElement.appendChild(li);
          updatePlayerCoupleStatusVisual(player);
        });
        updateScoreboardSidebar();
        /* Aggiorna ANCHE sidebar */ if (
          document.getElementById("setup-section").style.display === "block"
        ) {
          if (players.length >= 2) {
            updateCoupleDropdowns();
          }
        }
      }
      function isPlayerInCouple(playerName) {
        return couples.some((couple) => couple.includes(playerName));
      }
      function updatePlayerCoupleStatusVisual(playerName) {
        document.querySelectorAll("#players-list li").forEach((li) => {
          const nameSpan = li.querySelector(".player-name");
          if (nameSpan && nameSpan.textContent === playerName) {
            const coupleIconSpan = li.querySelector(".couple-icon");
            const uncoupleBtn = li.querySelector(".uncouple-btn");
            if (isPlayerInCouple(playerName)) {
              coupleIconSpan.textContent = " ❤️";
              uncoupleBtn.style.display = "inline-block";
            } else {
              coupleIconSpan.textContent = "";
              uncoupleBtn.style.display = "none";
            }
          }
        });
      }
      function updateCoupleSectionVisibility() {
        const coupleSection = document.getElementById("couple-section");
        const shouldBeVisible = players.length >= 2;
        coupleSection.style.display = shouldBeVisible ? "block" : "none";
        if (!shouldBeVisible && couples.length > 0) {
          couples = [];
          updatePlayersList(); /* Aggiorna lista e sidebar se coppie resettate */
        }
        if (shouldBeVisible) {
          updateCoupleDropdowns();
        }
      }
      function updateCoupleDropdowns() {
        const select1 = document.getElementById("couple-player1");
        const select2 = document.getElementById("couple-player2");
        if (!select1 || !select2) return;
        const currentVal1 = select1.value;
        const currentVal2 = select2.value;
        select1.innerHTML = '<option value="">Seleziona...</option>';
        select2.innerHTML = '<option value="">Seleziona...</option>';
        const availablePlayers = players.filter((p) => !isPlayerInCouple(p));
        availablePlayers.forEach((player) => {
          const option1 = document.createElement("option");
          option1.value = player;
          option1.textContent = player;
          select1.appendChild(option1);
          const option2 = document.createElement("option");
          option2.value = player;
          option2.textContent = player;
          select2.appendChild(option2);
        });
        if (availablePlayers.includes(currentVal1)) select1.value = currentVal1;
        if (availablePlayers.includes(currentVal2)) select2.value = currentVal2;
        document.getElementById("couple-btn").disabled =
          availablePlayers.length < 2;
      }
      function formCouple() {
        const player1 = document.getElementById("couple-player1").value;
        const player2 = document.getElementById("couple-player2").value;
        if (!player1 || !player2) {
          alert("Seleziona entrambi i giocatori!");
          return;
        }
        if (player1 === player2) {
          alert("I giocatori devono essere diversi!");
          return;
        }
        couples.push([player1, player2]);
        updatePlayersList();
        /* Aggiorna lista e sidebar */ document.getElementById(
          "couple-player1"
        ).value = "";
        document.getElementById("couple-player2").value = "";
      }
      function uncouplePlayers(playerName) {
        couples = couples.filter((couple) => !couple.includes(playerName));
        updatePlayersList(); /* Aggiorna lista e sidebar */
      }

      // -------- FUNZIONI FLUSSO DI GIOCO --------

      function startGame() {
        if (players.length < 2) return;
        players.forEach((player) => {
          playerScores[player] = 0;
        });
        updateScoreboardSidebar();

        currentChallengeData = null;

        document.getElementById("setup-section").style.display = "none";
        document.getElementById("scoreboard-section").style.display = "none";
        document.getElementById("game-section").style.display = "block";
        document.getElementById("scoreboard-sidebar").style.display = "block";
        document.getElementById("general-laugh-btn").style.display = "none";
        document
          .querySelectorAll(".score-actions")
          .forEach((div) => (div.style.display = "none"));
        document.getElementById("next-btn").disabled = true;
        nextChallenge();
      }

      function determineChallengeType() {
        /* ...identica a prima... */ const rand = Math.random() * 100;
        let cumulativeProb = 0;
        cumulativeProb += coupleChallengeProbability;
        if (couples.length > 0 && rand < cumulativeProb) {
          return { pool: coupleChallenges, type: "couple" };
        }
        cumulativeProb += groupChallengeProbability;
        if (rand < cumulativeProb) {
          return { pool: groupChallenges, type: "group" };
        }
        cumulativeProb += challengeModeProbability;
        if (players.length >= 2 && rand < cumulativeProb) {
          return { pool: challengeModeChallenges, type: "challenge" };
        }
        const oneVsOnePool = [
          ...compliments,
          ...roasts,
          ...uncomfortableQuestions,
        ];
        return { pool: oneVsOnePool, type: "single" };
      }

      // *** VERSIONE MODIFICATA DI selectParticipants ***
      function selectParticipants(targetType) {
        let fromPlayer = null; // Mittente (solo per 'single')
        let player1 = null; // Sfidante 1
        let player2 = null; // Sfidante 2
        let toTarget = null; // Target (nome, 'TUTTI', coppia)
        let currentTargetType = targetType;
        let currentPool = null;

        if (targetType === "challenge") {
          if (players.length < 2) return null;
          let indices = Array.from(players.keys());
          let index1 = indices.splice(
            Math.floor(Math.random() * indices.length),
            1
          )[0];
          let index2 = indices.splice(
            Math.floor(Math.random() * indices.length),
            1
          )[0];
          player1 = players[index1];
          player2 = players[index2];
          // fromPlayer rimane null
          // toTarget rimane null
        } else if (targetType === "couple") {
          if (couples.length === 0) {
            // Fallback
            currentTargetType = "group";
            currentPool = groupChallenges;
          } else {
            toTarget = couples[Math.floor(Math.random() * couples.length)];
            // Decidiamo che per le sfide coppia, il 'mittente' è irrilevante
            fromPlayer = null; // <-- CAMBIAMENTO: non selezioniamo mittente per coppie
          }
        } else if (targetType === "group") {
          // Non serve un mittente esplicito per la logica di scoring
          fromPlayer = null; // <-- CAMBIAMENTO
          toTarget = "TUTTI";
          // Potremmo comunque selezionare un giocatore FOCUS internamente se le domande lo richiedono
          // ma non lo usiamo per lo scoring o il display principale
          // let focusPlayer = players[Math.floor(Math.random() * players.length)]; // Esempio
        } else if (targetType === "single") {
          if (players.length < 2) {
            // Fallback se solo 1 giocatore
            currentTargetType = "group";
            currentPool = groupChallenges;
            toTarget = "TUTTI";
            fromPlayer = null;
          } else {
            fromPlayer = players[Math.floor(Math.random() * players.length)]; // Seleziona mittente
            let potentialTargets = players.filter((p) => p !== fromPlayer);
            toTarget =
              potentialTargets[
                Math.floor(Math.random() * potentialTargets.length)
              ];
          }
        }

        // Verifica finale coerenza
        if (currentTargetType === "challenge" && (!player1 || !player2))
          return null;
        // Per gli altri tipi, ora non necessariamente serve fromPlayer
        if (currentTargetType === "single" && (!fromPlayer || !toTarget))
          return null;
        if (currentTargetType === "couple" && !toTarget) return null; // Serve solo target coppia
        if (currentTargetType === "group" && toTarget !== "TUTTI") return null;

        return {
          from: fromPlayer, // Sarà null tranne per 'single'
          player1: player1,
          player2: player2,
          to: toTarget,
          type: currentTargetType,
          poolOverride: currentPool,
        };
      }

      // *** VERSIONE MODIFICATA DI determineScorablePlayers ***
      function determineScorablePlayers(challengeData) {
        if (!challengeData) return [];
        const type = challengeData.targetType;

        if (type === "single") {
          // Premiamo il mittente (chi fa complimento/roast)
          return challengeData.fromDisplay ? [challengeData.fromDisplay] : [];
        } else if (type === "couple") {
          // Premiamo entrambi i membri della coppia target
          return challengeData.toDisplay &&
            Array.isArray(challengeData.toDisplay)
            ? [...challengeData.toDisplay]
            : [];
        } else if (type === "challenge") {
          // Possibili vincitori sono gli sfidanti
          return [challengeData.player1, challengeData.player2];
        } else if (type === "group") {
          // Nessun scorable individuale, c'è il bottone generale
          return [];
        }
        return [];
      }

      // *** VERSIONE MODIFICATA DI updateChallengeUI ***
      function updateChallengeUI() {
        if (!currentChallengeData) return;
        const card = document.getElementById("challenge-card");
        const pairElement = document.getElementById("current-pair");
        const textElement = document.getElementById("challenge-text");
        const imageContainer = document.getElementById(
          "challenge-image-container"
        );
        const imageElement = document.getElementById("challenge-image");

        // Reset card e header
        card.className = "challenge-card"; // Rimuove classi specifiche precedenti
        pairElement.textContent = ""; // Pulisce header

        // Costruisci Header Display in base al tipo
        let displayHeader = "";
        const type = currentChallengeData.targetType;

        if (type === "couple") {
          card.classList.add("couple-challenge");
          // Ora mostra SOLO la coppia target
          displayHeader = `COPPIA: ${currentChallengeData.toDisplay[0]} & ${currentChallengeData.toDisplay[1]}`;
        } else if (type === "group") {
          card.classList.add("group-challenge");
          // Ora mostra SOLO TUTTI
          displayHeader = "SFIDA DI GRUPPO"; // O semplicemente "TUTTI" o niente? Proviamo così.
        } else if (type === "challenge") {
          card.classList.add("challenge-mode");
          displayHeader = `SFIDA: ${currentChallengeData.player1} vs ${currentChallengeData.player2}`;
        } else {
          // single
          // Mostra Mittente -> Target solo qui
          displayHeader = `${currentChallengeData.fromDisplay} → ${currentChallengeData.toDisplay}`;
        }
        pairElement.textContent = displayHeader;

        // Immagine e Testo (come prima)
        if (currentChallengeData.image) {
          imageElement.src = currentChallengeData.image;
          imageContainer.style.display = "block";
        } else {
          imageContainer.style.display = "none";
          imageElement.src = "";
        }
        textElement.textContent = currentChallengeData.challenge;

        // Bottone Risate Generali (gestito da updateSidebarHighlightAndActions)
      }

      // *** VERSIONE MODIFICATA di updateSidebarHighlightAndActions ***
      function updateSidebarHighlightAndActions() {
        const scorablePlayers = determineScorablePlayers(currentChallengeData);
        console.log("Giocatori Scorable:", scorablePlayers); // DEBUG

        document
          .querySelectorAll("#scoreboard-list .score-item")
          .forEach((item) => {
            const playerName = item.dataset.playerName;
            const actionsDiv = item.querySelector(".score-actions");
            const likeBtn = actionsDiv?.querySelector(".like-btn");
            const dislikeBtn = actionsDiv?.querySelector(".dislike-btn");
            const voteBtn = actionsDiv?.querySelector(".vote-winner-btn");

            // Reset
            item.classList.remove("highlight");
            actionsDiv.style.display = "none";
            if (likeBtn) {
              likeBtn.style.display = "none";
              likeBtn.disabled = true;
            }
            if (dislikeBtn) {
              dislikeBtn.style.display = "none";
              dislikeBtn.disabled = true;
            }
            if (voteBtn) {
              voteBtn.style.display = "none";
              voteBtn.disabled = true;
            }

            // Se giocatore è scorable
            if (scorablePlayers.includes(playerName)) {
              item.classList.add("highlight");
              actionsDiv.style.display = "flex";

              const isChallengeMode =
                currentChallengeData?.targetType === "challenge";

              if (isChallengeMode) {
                // Mostra 🏆 per sfide
                if (voteBtn) {
                  voteBtn.style.display = "inline-block";
                  voteBtn.disabled = false;
                }
              } else {
                // Mostra 👍/👎 per single/couple
                if (likeBtn) {
                  likeBtn.style.display = "inline-block";
                  likeBtn.disabled = false;
                }
                if (dislikeBtn) {
                  dislikeBtn.style.display = "inline-block";
                  dislikeBtn.disabled = false;
                }
              }
            }
          });

        // Bottone Risate Generali
        const generalLaughBtn = document.getElementById("general-laugh-btn");
        if (generalLaughBtn) {
          const isGroup = currentChallengeData?.targetType === "group";
          generalLaughBtn.style.display = isGroup ? "block" : "none";
          generalLaughBtn.disabled = !isGroup;
        }
      }

      // nextChallenge (aggiornata per usare la nuova selectParticipants)
      function nextChallenge() {
        if (players.length === 0) {
          endGame();
          return;
        }

        const challengeInfo = determineChallengeType();
        let participationInfo = selectParticipants(challengeInfo.type); // Ora ritorna from=null per non-single

        if (!participationInfo) {
          /* ... gestione fallback ... */ console.warn(
            "Selezione fallita, forzo gruppo."
          );
          if (players.length > 0) {
            participationInfo = {
              from: null,
              to: "TUTTI",
              type: "group",
              poolOverride: groupChallenges,
            };
            challengeInfo.pool = groupChallenges;
            challengeInfo.type = "group";
          } else {
            endGame();
            return;
          }
        }

        let currentPool = participationInfo.poolOverride || challengeInfo.pool;
        let finalTargetType = participationInfo.type;

        if (!currentPool || currentPool.length === 0) {
          /* ... fallback pool vuoto ... */
        }

        let challenge =
          currentPool[Math.floor(Math.random() * currentPool.length)];
        let challengeTextContent = challenge.text;
        let challengeImagePath =
          challenge.type === "image" && challenge.image
            ? challenge.image
            : null;

        // Sostituzione Placeholder (Modificata per gestire from=null)
        let finalChallengeText = challengeTextContent;
        if (finalTargetType === "challenge") {
          finalChallengeText = finalChallengeText
            .replace(/\[PLAYER_1\]/g, participationInfo.player1)
            .replace(/\[PLAYER_2\]/g, participationInfo.player2);
        } else if (finalTargetType === "single") {
          // Qui 'from' esiste
          finalChallengeText = finalChallengeText
            .replace(/\[MITTENTE\]/g, participationInfo.from)
            .replace(/\[PLAYER\]/g, participationInfo.to);
        } else if (finalTargetType === "group") {
          // Rimuovi [MITTENTE] se presente, o sostituisci [PLAYER] con info generica se serve
          // Scegliamo un giocatore focus SOLO per la sostituzione nel testo, se serve
          let focusPlayer = players[Math.floor(Math.random() * players.length)];
          finalChallengeText = finalChallengeText
            .replace(/\[MITTENTE\]/g, "Gioco")
            .replace(/\[PLAYER\]/g, focusPlayer); // Sostituisce [PLAYER] con un nome a caso per contesto
        } else if (finalTargetType === "couple") {
          // Rimuovi [MITTENTE] se presente
          finalChallengeText = finalChallengeText
            .replace(/\[MITTENTE\]/g, "Gioco")
            .replace(/\[COPPIA_1\]/g, participationInfo.to[0])
            .replace(/\[COPPIA_2\]/g, participationInfo.to[1])
            .replace(
              /\[PLAYER\]/g,
              `la coppia ${participationInfo.to[0]} & ${participationInfo.to[1]}`
            );
        }

        // Salva dati sfida
        currentChallengeData = {
          targetType: finalTargetType,
          player1: participationInfo.player1,
          player2: participationInfo.player2,
          fromDisplay: participationInfo.from, // Può essere null
          toDisplay: participationInfo.to,
          challenge: finalChallengeText,
          image: challengeImagePath,
        };

        updateChallengeUI();
        updateSidebarHighlightAndActions(); // Chiamata DOPO aver definito currentChallengeData
        document.getElementById("next-btn").disabled = false;
      }

      // assignPoints, assignGroupPoints, disableActionsAndAdvance (INVARIATE)
      function assignPoints(playerName, scoreType) {
        if (!currentChallengeData) return;
        const scorablePlayers = determineScorablePlayers(currentChallengeData);
        if (!scorablePlayers.includes(playerName)) return;
        let pointsToAdd = 0;
        if (scoreType === "like") pointsToAdd = likePoints;
        else if (scoreType === "dislike") pointsToAdd = dislikePoints;
        else if (scoreType === "challengeWin") pointsToAdd = challengeWinPoints;
        if (playerScores.hasOwnProperty(playerName)) {
          playerScores[playerName] += pointsToAdd;
          updatePlayerScoreVisual(playerName);
          console.log(
            `${playerName} riceve ${pointsToAdd} punti (${scoreType}). Totale: ${playerScores[playerName]}`
          );
        }
        disableActionsAndAdvance();
      }
      function assignGroupPoints() {
        if (
          !currentChallengeData ||
          currentChallengeData.targetType !== "group"
        )
          return;
        players.forEach((player) => {
          if (playerScores.hasOwnProperty(player)) {
            playerScores[player] += groupLaughPoints;
            updatePlayerScoreVisual(player);
          }
        });
        console.log(`Risate generali! +${groupLaughPoints} punti a tutti.`);
        disableActionsAndAdvance();
      }
      function disableActionsAndAdvance() {
        document
          .querySelectorAll(".score-actions button")
          .forEach((btn) => (btn.disabled = true));
        const generalLaughBtn = document.getElementById("general-laugh-btn");
        if (generalLaughBtn) generalLaughBtn.disabled = true;
        document.getElementById("next-btn").disabled = true;
        document
          .querySelectorAll("#scoreboard-list .score-item.highlight")
          .forEach((item) => {
            item.classList.remove("highlight");
            item.querySelector(".score-actions").style.display = "none";
          });
        setTimeout(() => {
          nextChallenge();
        }, 1300);
      }

      // endGame, resetGame (INVARIATE)
      function endGame() {
        /* ... come prima ... */ document.getElementById(
          "game-section"
        ).style.display = "none";
        document.getElementById("scoreboard-sidebar").style.display = "none";
        document.getElementById("scoreboard-section").style.display = "block";
        document.getElementById("setup-section").style.display = "none";
        const sortedPlayers = Object.keys(playerScores)
          .filter((p) => players.includes(p))
          .sort((a, b) => playerScores[b] - playerScores[a]);
        const scoreListFinal = document.getElementById("score-list-final");
        scoreListFinal.innerHTML = "";
        if (sortedPlayers.length > 0) {
          const winnerScore = playerScores[sortedPlayers[0]];
          sortedPlayers.forEach((player, index) => {
            const scoreItem = createScoreboardItem(player);
            const actionsDiv = scoreItem.querySelector(".score-actions");
            if (actionsDiv) actionsDiv.remove();
            if (playerScores[player] === winnerScore && winnerScore > 0)
              scoreItem.classList.add("winner");
            const nameSpan = scoreItem.querySelector(".score-name");
            nameSpan.textContent = `${index + 1}. ${player}`;
            const pointsSpan = scoreItem.querySelector(".score-points");
            pointsSpan.textContent =
              playerScores[player] !== undefined ? playerScores[player] : 0;
            scoreListFinal.appendChild(scoreItem);
          });
        } else {
          scoreListFinal.innerHTML =
            '<p style="text-align: center;">Nessun punteggio disponibile.</p>';
        }
      }
      function resetGame() {
        /* ... come prima ... */ players = [];
        couples = [];
        playerScores = {};
        currentChallengeData = null;
        document.getElementById("setup-section").style.display = "block";
        document.getElementById("game-section").style.display = "none";
        document.getElementById("scoreboard-section").style.display = "none";
        document.getElementById("scoreboard-sidebar").style.display = "none";
        document.getElementById("scoreboard-list").innerHTML = "";
        document.getElementById("players-list").innerHTML = "";
        document.getElementById("player-name").value = "";
        document.getElementById("couple-section").style.display = "none";
        if (document.getElementById("couple-player1"))
          document.getElementById("couple-player1").innerHTML =
            '<option value="">Seleziona...</option>';
        if (document.getElementById("couple-player2"))
          document.getElementById("couple-player2").innerHTML =
            '<option value="">Seleziona...</option>';
        if (document.getElementById("couple-btn"))
          document.getElementById("couple-btn").disabled = true;
        if (document.getElementById("start-btn"))
          document.getElementById("start-btn").disabled = true;
      }

      // Event listener Invio e Setup iniziale
      const playerNameInput = document.getElementById("player-name");
      if (playerNameInput) {
        playerNameInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            addPlayer();
          }
        });
      }
      resetGame();
    </script>
  </body>
</html>
