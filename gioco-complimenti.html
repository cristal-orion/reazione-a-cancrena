<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reazione a Cancrena - V3</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      /* Nuova palette colori più vivace */
      :root {
        --primary-color: #ff4757; /* Rosso più vibrante */
        --primary-dark: #e83142;
        --secondary-color: #5352ed; /* Blu vivace */
        --secondary-dark: #3f3fbf;
        --accent-color: #f9f9fa;
        --dark-text: #2c3a47;
        --light-bg: #f1f2f6;
        --laugh-color: #2ed573; /* Verde più vivace */
        --laugh-dark: #1cb058;
        --cry-color: #70a1ff; /* Blu più chiaro */
        --cry-dark: #5886e0;
        --warning-color: #ffa502; /* Arancione più brillante */
        --warning-dark: #e08a00;
        --winner-bg: #ffd700;
        --challenge-color: #9b59b6; /* Viola più moderno */
        --challenge-dark: #8e44ad;
        --couple-icon-color: #ff6b81; /* Rosa più moderno */
        --like-color: #2ed573;
        --dislike-color: #ff4757;
        --highlight-bg: #e0f7fa;
        --border-radius-main: 16px; /* Bordi più arrotondati */
        --box-shadow-light: 0 6px 20px rgba(0, 0, 0, 0.08);
        --box-shadow-medium: 0 10px 28px rgba(0, 0, 0, 0.15);
        --box-shadow-hover: 0 14px 32px rgba(0, 0, 0, 0.2);
      }

      /* Importazione font più giocosi */
      @import url("https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap");

      body {
        font-family: "Nunito", sans-serif;
        background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
        min-height: 100vh;
        padding: 20px;
        display: flex;
        justify-content: center;
        box-sizing: border-box;
      }

      /* Titolo principale più accattivante */
      h1 {
        color: var(--primary-color);
        text-align: center;
        margin-bottom: 30px;
        font-family: "Fredoka One", cursive;
        font-size: 3em;
        width: 100%;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        letter-spacing: 1px;
        background: linear-gradient(
          90deg,
          var(--primary-color),
          var(--secondary-color)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      /* Container con sfondo sfumato */
      .container,
      #setup-section,
      #game-section,
      #scoreboard-section {
        border-radius: var(--border-radius-main);
        background: white;
        box-shadow: var(--box-shadow-medium);
        padding: 30px 40px;
        position: relative;
        overflow: hidden;
      }

      /* Miglioramento aspetto bottoni */
      #setup-section button,
      #game-section button {
        padding: 14px 28px;
        margin: 10px 5px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        font-weight: 700;
        font-size: 1em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
      }

      #setup-section button:hover:not(:disabled),
      #game-section button:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: var(--box-shadow-hover);
      }

      /* Pulsante principale più attraente */
      .input-group button,
      #start-btn,
      #couple-btn {
        background: linear-gradient(
          45deg,
          var(--primary-color),
          var(--primary-dark)
        );
        color: white;
      }

      /* Card sfida più attraente */
      .challenge-card {
        border-radius: var(--border-radius-main);
        padding: 35px 40px;
        margin: 0 0 25px 0;
        box-shadow: var(--box-shadow-medium);
        min-height: 280px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        transition: all 0.5s ease;
        border: none;
        position: relative;
        overflow: hidden;
        text-align: center;
      }

      /* Sfondi sfumati per le card sfida */
      .group-challenge {
        background: linear-gradient(135deg, #ffefba, #ffffff);
        border-left: 6px solid var(--warning-color);
      }

      .couple-challenge {
        background: linear-gradient(135deg, #e0c3fc, #fff);
        border-left: 6px solid var(--challenge-color);
      }

      .challenge-mode {
        background: linear-gradient(135deg, #a1c4fd, #fff);
        border-left: 6px solid var(--secondary-color);
      }

      /* Miglioramento visualizzazione giocatori */
      li.player-item {
        padding: 14px 16px;
        margin: 8px 0;
        background-color: var(--light-bg);
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.1em;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      li.player-item:hover {
        background-color: #e9ecef;
        transform: translateX(3px);
      }

      /* Scoreboard più attraente */
      .scoreboard-sidebar {
        border-radius: var(--border-radius-main);
        background: white;
        box-shadow: var(--box-shadow-medium);
        padding: 25px;
        height: fit-content;
        position: sticky;
        top: 20px;
      }

      .scoreboard-sidebar h2 {
        font-family: "Fredoka One", cursive;
        color: var(--primary-color);
        border-bottom: 3px solid var(--primary-color);
        padding-bottom: 10px;
      }

      li.score-item {
        padding: 14px 16px;
        margin-bottom: 10px;
        border-radius: 10px;
        background-color: var(--light-bg);
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      li.score-item.highlight {
        background: linear-gradient(45deg, var(--highlight-bg), #f5ffff);
        box-shadow: 0 0 12px rgba(79, 189, 217, 0.6);
        transform: scale(1.02);
      }

      /* Animazione per le azioni di punteggio */
      .score-actions button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.6em;
        transition: all 0.2s ease;
      }

      .score-actions button:hover {
        transform: scale(1.3);
      }

      /* Sezione coppie più attraente */
      #couple-section {
        margin-top: 30px;
        padding: 25px;
        border-radius: var(--border-radius-main);
        background: linear-gradient(135deg, #e0f7fa, #ffffff);
        box-shadow: var(--box-shadow-light);
      }

      /* Input più moderni */
      #setup-section input[type="text"],
      #setup-section select {
        padding: 14px 18px;
        margin: 5px 0 15px 0;
        border-radius: 10px;
        border: 1px solid #ddd;
        width: calc(100% - 36px);
        font-size: 1em;
        box-sizing: border-box;
        transition: all 0.3s ease;
        background-color: white;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      #setup-section input[type="text"]:focus,
      #setup-section select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(255, 71, 87, 0.2);
      }

      /* Animazioni per elementi interattivi */
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      #general-laugh-btn {
        animation: pulse 2s infinite;
      }

      /* Media query per responsiveness migliorata */
      @media (max-width: 900px) {
        .main-layout {
          flex-direction: column;
          align-items: center;
        }

        h1 {
          font-size: 2.4em;
        }

        .scoreboard-sidebar,
        .game-content {
          width: 100%;
          max-width: 100%;
        }
      }

      @media (max-width: 600px) {
        h1 {
          font-size: 2em;
        }

        #setup-section,
        #game-section,
        #scoreboard-section {
          padding: 20px;
        }

        .challenge-card {
          padding: 25px 20px;
        }
      }
      /* ===== EFFETTI E ANIMAZIONI ===== */

      /* Animazione per i cambi di schermata */
      .fade-in {
        animation: fadeIn 0.5s ease forwards;
      }

      .fade-out {
        animation: fadeOut 0.3s ease forwards;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
          transform: translateY(0);
        }
        to {
          opacity: 0;
          transform: translateY(-10px);
        }
      }

      /* Animazione per l'aggiunta di player */
      .player-added {
        animation: playerAdded 0.5s ease;
      }

      @keyframes playerAdded {
        0% {
          transform: translateX(-20px);
          opacity: 0;
        }
        100% {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Animazione per rimozione player */
      .player-removed {
        animation: playerRemoved 0.3s ease forwards;
      }

      @keyframes playerRemoved {
        0% {
          transform: translateX(0);
          opacity: 1;
        }
        100% {
          transform: translateX(20px);
          opacity: 0;
        }
      }

      /* Shake per input errati */
      .shake {
        animation: shake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
      }

      @keyframes shake {
        10%,
        90% {
          transform: translate3d(-1px, 0, 0);
        }
        20%,
        80% {
          transform: translate3d(2px, 0, 0);
        }
        30%,
        50%,
        70% {
          transform: translate3d(-3px, 0, 0);
        }
        40%,
        60% {
          transform: translate3d(3px, 0, 0);
        }
      }

      /* Toast di notifica */
      .toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        font-size: 0.95em;
        z-index: 1000;
        opacity: 0;
        transition: all 0.3s ease;
      }

      .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }

      /* Animazione cambio card */
      .card-change {
        animation: cardChange 0.3s ease;
      }

      @keyframes cardChange {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(0.95);
          opacity: 0.5;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* Animazione apparizione testo */
      .text-appear {
        animation: textAppear 0.6s ease;
      }

      @keyframes textAppear {
        0% {
          opacity: 0;
          transform: translateY(10px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Effetti per l'assegnazione punti */
      .point-bubble {
        position: absolute;
        top: -20px;
        right: 10px;
        background-color: var(--like-color);
        color: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        animation: bubbleUp 1s forwards;
      }

      @keyframes bubbleUp {
        0% {
          transform: scale(0.5);
          opacity: 0;
        }
        20% {
          transform: scale(1.2);
          opacity: 1;
        }
        80% {
          transform: scale(1) translateY(-15px);
          opacity: 1;
        }
        100% {
          transform: scale(0.5) translateY(-30px);
          opacity: 0;
        }
      }

      /* Effetto vittoria sfida */
      .winner-effect {
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(45deg, #ffd700, #f7c200);
        color: #1e1e1e;
        padding: 5px 12px;
        border-radius: 15px;
        font-weight: bold;
        box-shadow: 0 2px 10px rgba(255, 215, 0, 0.5);
        animation: winnerEffect 1.5s forwards;
      }

      @keyframes winnerEffect {
        0% {
          transform: translateX(-50%) scale(0.8);
          opacity: 0;
        }
        20% {
          transform: translateX(-50%) scale(1.1);
          opacity: 1;
        }
        80% {
          transform: translateX(-50%) scale(1) translateY(-10px);
          opacity: 1;
        }
        100% {
          transform: translateX(-50%) scale(0.8) translateY(-20px);
          opacity: 0;
        }
      }

      /* Effetto risata di gruppo */
      .group-laugh-effect {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(
          45deg,
          var(--laugh-color),
          var(--laugh-dark)
        );
        color: white;
        padding: 15px 25px;
        border-radius: 20px;
        font-size: 1.2em;
        font-weight: bold;
        text-align: center;
        box-shadow: 0 5px 15px rgba(46, 213, 115, 0.5);
        animation: groupLaughEffect 1.5s forwards;
        z-index: 100;
      }

      @keyframes groupLaughEffect {
        0% {
          transform: translate(-50%, -50%) scale(0.5);
          opacity: 0;
        }
        20% {
          transform: translate(-50%, -50%) scale(1.1);
          opacity: 1;
        }
        70% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 1;
        }
        100% {
          transform: translate(-50%, -50%) scale(1.5);
          opacity: 0;
        }
      }

      /* Badge tipo sfida */
      .challenge-type-badge {
        position: absolute;
        top: -12px;
        left: 20px;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: bold;
        color: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 10;
      }

      .single-badge {
        background: linear-gradient(
          45deg,
          var(--primary-color),
          var(--primary-dark)
        );
      }

      .couple-badge {
        background: linear-gradient(45deg, #9b59b6, #8e44ad);
      }

      .group-badge {
        background: linear-gradient(
          45deg,
          var(--warning-color),
          var(--warning-dark)
        );
      }

      .challenge-badge {
        background: linear-gradient(
          45deg,
          var(--secondary-color),
          var(--secondary-dark)
        );
      }

      /* Contatore giocatori */
      .player-counter {
        text-align: center;
        margin: 10px 0 15px;
        padding: 5px 10px;
        border-radius: 15px;
        display: inline-block;
        font-size: 0.9em;
        font-weight: 600;
        background-color: #f1f2f6;
        color: var(--dark-text);
        transition: all 0.3s ease;
      }

      .few-players {
        color: var(--warning-color);
      }

      .enough-players {
        color: var(--secondary-color);
      }

      .many-players {
        color: var(--primary-color);
        font-weight: 700;
      }

      /* Indicatore turno */
      .turn-indicator {
        text-align: center;
        margin-top: 15px;
        font-size: 0.9em;
        color: var(--secondary-color);
        font-weight: 600;
      }

      /* Animazione foto caricata */
      .image-loaded {
        animation: imageReveal 0.5s ease forwards;
      }

      @keyframes imageReveal {
        0% {
          opacity: 0;
          transform: scale(0.9);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* Regole del gioco */
      .rules-container {
        margin-top: 25px;
        border-top: 1px solid #eee;
        padding-top: 15px;
      }

      .rules-toggle {
        background: none;
        border: none;
        color: var(--secondary-color);
        cursor: pointer;
        font-size: 0.9em;
        padding: 5px 10px;
        border-radius: 5px;
        transition: all 0.2s;
        width: 100%;
        text-align: left;
        display: flex;
        align-items: center;
      }

      .rules-toggle i {
        margin-right: 5px;
      }

      .rules-toggle:hover {
        background-color: #f8f9fa;
      }

      .rules-content {
        font-size: 0.85em;
        padding: 10px;
        margin-top: 10px;
        background-color: #f8f9fa;
        border-radius: 8px;
        line-height: 1.4;
      }

      .rules-content p {
        margin-top: 0;
      }

      .rules-content ul {
        padding-left: 20px;
        margin-bottom: 0;
      }

      /* Stile per la schermata finale */
      .final-score-item {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        margin-bottom: 10px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.3s ease;
      }

      .final-score-item.show {
        opacity: 1;
        transform: translateY(0);
      }

      .final-score-item.winner {
        background: linear-gradient(to right, #ffd700, #faf0be);
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        transform: scale(1.03);
      }

      .rank {
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--secondary-color);
        color: white;
        border-radius: 50%;
        font-weight: bold;
        margin-right: 15px;
        font-size: 1.2em;
      }

      .final-score-item.winner .rank {
        background-color: var(--primary-color);
      }

      .final-name {
        flex-grow: 1;
        font-weight: 600;
        font-size: 1.1em;
      }

      .final-points {
        font-weight: 700;
        color: var(--secondary-color);
        font-size: 1.15em;
      }

      .final-score-item.winner .final-points {
        color: var(--primary-dark);
      }

      /* Statistiche finali */
      .final-stats {
        margin-top: 30px;
        padding: 20px;
        background: white;
        border-radius: var(--border-radius-main);
        box-shadow: var(--box-shadow-light);
      }

      .final-stats h3 {
        text-align: center;
        color: var(--secondary-color);
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 1.3em;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-item {
        text-align: center;
        padding: 10px;
        border-radius: 10px;
        background-color: #f8f9fa;
        transition: all 0.2s;
      }

      .stat-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 12px rgba(0, 0, 0, 0.08);
      }

      .stat-icon {
        font-size: 1.5em;
        color: var(--secondary-color);
        margin-bottom: 5px;
      }

      .stat-value {
        font-size: 1.8em;
        font-weight: 700;
        color: var(--dark-text);
      }

      .stat-label {
        font-size: 0.85em;
        color: #777;
      }

      .special-stats {
        font-size: 0.95em;
        color: var(--dark-text);
        line-height: 1.6;
      }

      .special-stat {
        padding: 8px 12px;
        margin-bottom: 8px;
        background: #f1f2f6;
        border-radius: 8px;
      }

      .special-stat i {
        color: var(--primary-color);
        margin-right: 5px;
      }

      /* Bottone start game */
      .start-game-container {
        margin-top: 25px;
        text-align: center;
      }

      #start-btn {
        padding: 15px 35px;
        font-size: 1.2em;
        background: linear-gradient(
          45deg,
          var(--primary-color),
          var(--primary-dark)
        );
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(230, 57, 70, 0.3);
      }

      #start-btn:not(:disabled):hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(230, 57, 70, 0.4);
      }

      #start-btn i {
        margin-right: 8px;
      }

      /* Animazioni responsive */
      @media (max-width: 768px) {
        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 480px) {
        .winner-effect,
        .point-bubble {
          font-size: 0.9em;
        }

        .group-laugh-effect {
          padding: 10px 15px;
          font-size: 1em;
        }
      }
    </style>
  </head>
  <body>
    <div class="main-layout">
      <!-- Colonna Sinistra: Contenuto Gioco (Setup o Sfida) -->
      <div class="game-content">
        <h1>
          <i class="fas fa-fire-alt"></i> Reazione a Cancrena
          <i class="fas fa-fire-alt"></i>
        </h1>
        <!-- Sezione Setup (Inizialmente Visibile) -->
        <div id="setup-section">
          <h2>Crea la tua Squadra (e Coppie)</h2>
          <div class="input-group">
            <input
              type="text"
              id="player-name"
              placeholder="Nome giocatore..."
            />
            <button onclick="addPlayer()">Aggiungi</button>
          </div>
          <ul id="players-list"></ul>
          <div id="couple-section" style="display: none">
            <h3>Forma Coppie (Opzionale)</h3>
            <div class="couple-selectors">
              <div>
                <label for="couple-player1">Giocatore 1:</label>
                <select id="couple-player1">
                  <option value="">Seleziona...</option>
                </select>
              </div>
              <div>
                <label for="couple-player2">Giocatore 2:</label>
                <select id="couple-player2">
                  <option value="">Seleziona...</option>
                </select>
              </div>
            </div>
            <button id="couple-btn" onclick="formCouple()" disabled>
              Abbina Coppia
            </button>
          </div>
          <button onclick="startGame()" id="start-btn" disabled>
            Inizia Gioco
          </button>
        </div>

        <!-- Sezione Gioco (Inizialmente Nascosta) -->
        <div id="game-section">
          <div class="challenge-card" id="challenge-card">
            <!-- Contenuto dinamico sfida -->
            <div id="challenge-image-container">
              <img id="challenge-image" src="" alt="Immagine Sfida" />
            </div>
            <div class="players-pair" id="current-pair"></div>
            <div class="challenge-text" id="challenge-text"></div>
            <!-- Bottone Risate Generali (solo per gruppo) -->
            <button id="general-laugh-btn" onclick="assignGroupPoints()">
              RISATE GENERALI 🎉 (+1 a tutti)
            </button>
          </div>
          <!-- Controlli generali gioco -->
          <div class="game-controls">
            <button onclick="nextChallenge()" id="next-btn">
              Prossima Sfida
            </button>
            <button class="end-btn" onclick="endGame()">Termina Partita</button>
          </div>
        </div>

        <!-- Sezione Scoreboard Finale (Inizialmente Nascosta) -->
        <div id="scoreboard-section">
          <h2>Classifica Finale</h2>
          <div id="score-list-final" class="score-list-final">
            <!-- Contenuto generato da JS -->
          </div>
          <div class="game-controls">
            <button onclick="resetGame()">Nuova Partita</button>
          </div>
        </div>
      </div>

      <!-- Colonna Destra: Scoreboard Sidebar (Visibile durante gioco) -->
      <div
        class="scoreboard-sidebar"
        id="scoreboard-sidebar"
        style="display: none"
      >
        <!-- Nascosto finché il gioco non inizia -->
        <h2>Punteggi</h2>
        <ul id="scoreboard-list">
          <!-- Contenuto generato da JS -->
          <!-- Esempio Item (verrà clonato):
                <li class="score-item" data-player-name="NomeGiocatore">
                    <span class="score-name">NomeGiocatore</span>
                    <span class="score-points">0</span>
                    <div class="score-actions">
                        <button class="like-btn" title="Assegna Punto" onclick="assignPoints('NomeGiocatore', 'like')">👍</button>
                        <button class="dislike-btn" title="Nessun Punto" onclick="assignPoints('NomeGiocatore', 'dislike')">👎</button>
                        <button class="vote-winner-btn" title="Vincitore Sfida" onclick="assignPoints('NomeGiocatore', 'challengeWin')"> </button>
                    </div>
                </li>
                 -->
        </ul>
      </div>
    </div>

    <script>
      // -------- STATO DEL GIOCO --------
      let players = [];
      let couples = [];
      let playerScores = {};
      let currentChallengeData = null;

      // Probabilità
      const oneVsOneProbability = 45;
      const groupChallengeProbability = 20;
      const coupleChallengeProbability = 20;
      const challengeModeProbability = 15;
      // Punti
      const likePoints = 1;
      const dislikePoints = 0;
      const challengeWinPoints = 3;
      const groupLaughPoints = 1;

      // -------- ARRAY DELLE SFIDE --------
      // (Riutilizza gli array completi con le tue immagini dall'ultimo codice - omessi per brevità)
      const compliments = [
        {
          type: "text",
          text: "Se [PLAYER] fosse un colore, quale sarebbe e perché emana quella particolare 'vibrazione'?",
        },
        {
          type: "text",
          text: "Quale canzone descrive perfettamente l'energia o lo spirito di [PLAYER]?",
        },
        {
          type: "image",
          text: "Anche questo Gatto Kung Fu ha i suoi momenti di tenerezza. Fai a [PLAYER] un complimento sulla sua capacità nascosta di essere dolce o premuroso/a.",
          image: "images/Gatto_allungato_mossa_KungFu.jpg",
        },
        {
          type: "text",
          text: "Descrivi la voce di [PLAYER] usando solo nomi di cibi (es: 'vellutata come un budino', 'croccante come un biscotto', 'frizzante come l'acqua tonica').",
        },
        {
          type: "text",
          text: "Se l'aura di [PLAYER] avesse un odore, quale sarebbe (deve essere un odore piacevole ma strano, es: 'plastilina nuova e vaniglia', 'benzina e lavanda')?",
        },
        {
          type: "image",
          text: "Questo Asino Cartoon sembra confuso ma buono. Fai un complimento a [PLAYER] sulla sua genuinità o sulla sua incapacità di essere veramente cattivo/a.",
          image: "images/Asino_con_occhi_grandi_cartoon.jpg",
        },
        {
          type: "text",
          text: "Qual è la cosa più intelligentemente pigra che hai visto fare a [PLAYER] e che segretamente ammiri?",
        },
        {
          type: "image",
          text: "Questa Lontra Umana ([PLAYER]?) ha degli occhi penetranti. Fai un complimento sincero a [PLAYER] sul suo sguardo o sulla sua profondità.",
          image: "images/Lontra_umana_con_occhi_azzurri.jpg",
        },
        {
          type: "text",
          text: "Descrivi un piccolo gesto quasi invisibile di [PLAYER] che però trovi significativo.",
        },
        {
          type: "text",
          text: "Fai un complimento a [PLAYER] su una sua caratteristica fisica o di stile che ti piace.",
        },
        {
          type: "text",
          text: "Se [PLAYER] fosse un fenomeno atmosferico (sole, pioggia...), quale sarebbe e perché?",
        },
        {
          type: "image",
          text: "Nonostante la puzza, questo cane ha un suo perché. Trova un pregio 'nascosto' di [PLAYER] e descrivilo.",
          image: "images/un_cane_puzza.jpg",
        },
        {
          type: "text",
          text: "Fai un complimento sincero su una qualità del carattere che ammiri profondamente in [PLAYER].",
        },
        {
          type: "text",
          text: "Condividi qualcosa di concreto che hai imparato grazie a [PLAYER].",
        },
        {
          type: "text",
          text: "Descrivi [PLAYER] in tre aggettivi precisi (non banali!) e spiega la scelta.",
        },
        {
          type: "image",
          text: "Questo Gatto Kung Fu ha stile. Fai un complimento a [PLAYER] sulla sua agilità (fisica o mentale) o sul suo stile unico.",
          image: "images/Gatto_allungato_mossa_KungFu.jpg",
        },
        {
          type: "text",
          text: "Se [PLAYER] fosse un piatto gourmet, quali ingredienti conterrebbe e perché?",
        },
        {
          type: "text",
          text: "Descrivi l'aura di [PLAYER] usando solo colori e sensazioni tattili.",
        },
        {
          type: "text",
          text: "Se [PLAYER] potesse essere un elemento architettonico di un edificio storico, quale sarebbe e perché?",
        },
        {
          type: "text",
          text: "Se [PLAYER] fosse un profumo, quali note avrebbe e in quale situazione sarebbe perfetto indossarlo?",
        },
        {
          type: "text",
          text: "Quale superpotere segreto pensi abbia [PLAYER] nella vita quotidiana?",
        },
        {
          type: "text",
          text: "Quale animale mitologico rappresenta meglio l'essenza di [PLAYER] e perché?",
        },
        {
          type: "text",
          text: "Descrivi un talento nascosto che [PLAYER] potrebbe avere ma che non ha ancora rivelato al mondo.",
        },
        {
          type: "text",
          text: "Se [PLAYER] fosse un pianeta del nostro sistema solare, quale sarebbe e perché si adatta alla sua personalità?",
        },
      ];
      const roasts = [
        {
          type: "text",
          text: "Se [PLAYER] fosse un meme famoso, quale sarebbe?",
        },
        {
          type: "image",
          text: "Questa immagine è chiaramente [PLAYER] al mattino prima del caffè. Confermi? Motiva il roast.",
          image: "images/Shrek_con_sorriso_memico.jpg",
        },
        {
          type: "text",
          text: "Quale oggetto inanimato in questa stanza assomiglia di più (caratterialmente) a [PLAYER]? Spiega il perché.",
        },
        {
          type: "image",
          text: "Se [PLAYER] dovesse dare un nome 'epico' a questo Cane Stupito, quale sarebbe e perché si addice a entrambi?",
          image: "images/Cane_con_faccia_stupita_e_sproporzionata.jpg",
        },
        {
          type: "text",
          text: "[PLAYER] viene morso da un ragno radioattivo. Quale superpotere TOTALMENTE INUTILE ottiene (es: 'sentire il sapore dei colori', 'parlare con i semafori spenti')?",
        },
        {
          type: "text",
          text: "Imita il modo in cui [PLAYER] cammina quando pensa di essere figo/a ma in realtà sembra solo strano.",
        },
        {
          type: "image",
          text: "Quale frase tipica di [PLAYER] si abbinerebbe perfettamente a questa immagine dell'Uomo-Baffo?",
          image: "images/Uomo_con_baffi_filter_volto_allungato.jpg",
        },
        {
          type: "text",
          text: "Se dovessi riassumere l'essenza di [PLAYER] con un rumore di notifica del telefono, quale sarebbe?",
        },
        {
          type: "image",
          text: "Ammettilo, l'espressione di questo Asino non ti ricorda *perfettamente* [PLAYER] quando è confuso/a?",
          image: "images/Asino_con_occhi_grandi_cartoon.jpg",
        },
        {
          type: "text",
          text: "Qual è il superpotere più gloriosamente inutile che [PLAYER] potrebbe possedere?",
        },
        {
          type: "text",
          text: "Chiedi a [PLAYER]: 'Da 1 a 10, quanto ti senti 'Mr. Carrot' oggi?' Spiega il punteggio.",
          image: "images/Mr_Carrot_testa_umanoide_conici.jpg",
        },
        {
          type: "image",
          text: "Questa Arancia con faccia di scimmia è chiaramente l'animale spirituale di [PLAYER]. Concordi? Motiva.",
          image: "images/Arancia_con_faccia_di_scimmia.jpg",
        },
        {
          type: "text",
          text: "Descrivi la 'modalità Autopilot' di [PLAYER]: cosa fa quando sembra disconnesso?",
        },
        {
          type: "image",
          text: "Se [PLAYER] dovesse usare questa faccia da casa arrabbiata per spaventare qualcuno, funzionerebbe?",
          image: "images/Casa_con_faccia_umano_arrabbiato.jpg",
        },
        {
          type: "text",
          text: "Traduci la risata di [PLAYER] in un suono onomatopeico strano.",
        },
        {
          type: "image",
          text: "Questo è [PLAYER] dopo una serata impegnativa, vero?",
          image: "images/woody_strafatto.jpg",
        },
        {
          type: "text",
          text: "Fai un roast *gentile* a [PLAYER] su un suo difettuccio, ma poi smorza con un complimento.",
        },
        {
          type: "text",
          text: "Imita (senza cattiveria!) un'espressione facciale o un gesto tipico di [PLAYER].",
        },
        {
          type: "image",
          text: "L'urlo di questo Ippopotamo è come quello di [PLAYER] quando... (completa la frase)",
          image: "images/Ippopotamo_gridante_su_sfondo_giallo.jpg",
        },
        {
          type: "image",
          text: "Onestamente, [PLAYER], quanto ti senti rappresentato/a da questo Gatto Vampiro?",
          image: "images/Gatto_arrabbiato_con_denti_da_vampiro.jpg",
        },
        {
          type: "text",
          text: "Se [PLAYER] fosse un elettrodomestico malfunzionante, quale sarebbe e cosa farebbe di strano?",
        },
        {
          type: "text",
          text: "Quale personaggio dei cartoni animati flop degli anni '90 ricorda di più [PLAYER] quando è stanco/a?",
        },
        {
          type: "text",
          text: "Descrivi [PLAYER] come se fosse la peggiore recensione a 1 stella di un ristorante di lusso.",
        },
        {
          type: "text",
          text: "Se la postura di [PLAYER] potesse parlare, quale frase ripeterebbe continuamente?",
        },
        {
          type: "text",
          text: "Quale emoji descrive meglio la faccia di [PLAYER] quando cerca di sembrare intelligente?",
        },
        {
          type: "text",
          text: "Se la vita di [PLAYER] fosse un film di serie B, quale sarebbe il titolo e la trama assurda?",
        },
        {
          type: "text",
          text: "Se lo stile di [PLAYER] fosse un piatto di cucina fusion andato male, quali ingredienti incompatibili conterrebbe?",
        },
        {
          type: "text",
          text: "Quale trend di TikTok ormai superato [PLAYER] probabilmente segue ancora in segreto?",
        },
      ];
      const uncomfortableQuestions = [
        {
          type: "image",
          text: "[PLAYER], fissa questo ciccione viola per 10 secondi. Ora confessa il primo pensiero *veramente* assurdo che ti è venuto.",
          image: "images/Alieno_viola_in_foresta_fluorescente.jpg",
        },
        {
          type: "text",
          text: "[PLAYER], descrivi al gruppo, con un livello di dettaglio quasi chirurgico (ma senza volgarità gratuita!), la tua procedura ESATTA per lavarti i piedi quando fai la doccia. Non saltare passaggi.",
        },
        {
          type: "text",
          text: "[PLAYER], devi raccontarci una cosa assolutamente normale e banale che hai fatto oggi (es: versare l'acqua). Raccontala nel modo più piatto e noioso possibile. L'obiettivo è *non* far ridere.",
        },
        {
          type: "text",
          text: "[PLAYER], qual è quella cosa *veramente* strana o super specifica che pensi faccia ridere solo te? Confessala e prova a spiegare perché.",
        },
        {
          type: "text",
          text: "[PLAYER], scenario assurdo: sei all'Eurospin. Quale attore/attrice italiano/a completamente fuori luogo vorresti trovare lì come commesso/a e perché?",
        },
        {
          type: "text",
          text: "[PLAYER], onestamente, che tipo specifico di scarpa ti senti di essere in questo momento della tua vita (es: 'ciabatta consumata', 'stivale rotto', 'calzino antiscivolo')? Motiva.",
        },
        {
          type: "text",
          text: "[PLAYER], come si chiama il parroco della tua parrocchia/zona? (Se non lo sai, puoi dire 'Passo' o inventare).",
        }, // Attenzione: potenzialmente sensibile
        {
          type: "image",
          text: "Se questa Casa Furente fosse la casa d'infanzia di [PLAYER], quale sarebbe il ricordo più strano associato?",
          image: "images/Casa_con_faccia_umano_arrabbiato.jpg",
        },
        {
          type: "text",
          text: "[PLAYER], preferiresti avere un terzo braccio che spunta dalla schiena o non avere più le ginocchia?",
        },
        {
          type: "text",
          text: "[PLAYER], qual è il tuo gusto di gelato 'guilty pleasure' più imbarazzante (quello che mangeresti di nascosto)?",
        },
        {
          type: "image",
          text: "[PLAYER], confessa: quanto spesso ti senti come questo Ippopotamo urlante interiormente durante una normale giornata lavorativa/scolastica?",
          image: "images/Ippopotamo_gridante_su_sfondo_giallo.jpg",
        },
        {
          type: "text",
          text: "[PLAYER], se la tua vita fosse un film, quale sarebbe il titolo più brutalmente onesto?",
        },
        {
          type: "image",
          text: "Fissa l'Uovo con gli occhiali per 5 secondi. Ora [PLAYER], chiudi gli occhi e descrivi la prima forma geometrica che ti viene in mente.",
          image: "images/Uovo_con_occhiali_e_volto_umano.jpg",
        },
        {
          type: "text",
          text: "[PLAYER], quale sarebbe la tua frase celebre se fossi il cattivo in un film Disney di serie B?",
        },
        {
          type: "text",
          text: "Devi eliminare per sempre una delle seguenti cose dalla tua vita: la pizza o la musica. Cosa scegli, [PLAYER]?",
        },
        {
          type: "image",
          text: "Questo Mr. Carrot è il tuo spirito guida o il tuo peggior incubo, [PLAYER]?",
          image: "images/Mr_Carrot_testa_umanoide_conici.jpg",
        },
        {
          type: "text",
          text: "[PLAYER], domanda fondamentale: che tipo di elettrodomestico ti senti OGGI e perché?",
        },
        {
          type: "text",
          text: "[PLAYER], quale specifica ora NON ESISTENTE del giorno (es: le 25:77) ti senti in questo momento e perché?",
        },
        {
          type: "image",
          text: "Questa immagine rappresenta [PLAYER] quando cerca di spiegare qualcosa di complicato? Siate sinceri.",
          image: "images/Uomo_con_baffi_filter_volto_allungato.jpg",
        },
        {
          type: "text",
          text: "[PLAYER],crea una frase per questo meme famoso",
          image: "Gigachad.jpg",
        },
        {
          type: "text",
          text: "Chiedi a [PLAYER]: 'Hai mai cagato in discoteca? Inteso come posto peggiore / momento peggiore dove aver fatto la cacca'",
        },
        {
          type: "image",
          text: "Questa Maschera Inquietante è come ti immagini la coscienza di [PLAYER]? Spiega.",
          image: "images/Maschera_bianca_inquietante_su_uomo.jpg",
        },
        {
          type: "text",
          text: "[PLAYER], preferiresti essere ricercato dalla polizia o da una pericolosa organizzazione criminale?",
        },
        {
          type: "text",
          text: "Chiedi a [PLAYER]: 'Qual è il pensiero più socialmente inaccettabile (ma che non diresti mai) che hai avuto guardando un reality show?'",
        },
        {
          type: "image",
          text: "[MITTENTE], [PLAYER] sarebbe più l'Omino Grasso o il suo destriero invisibile?",
          image: "images/Omino_grasso_stile_cartoon_in_armatura.jpg",
        }, // Modificata
        {
          type: "image",
          text: "[MITTENTE], cosa ne pensa [PLAYER] di questa Scimmia con caschetto?",
          image: "images/Scimmia_caschetto_stile_moderno.jpg",
        }, // Modificata
        {
          type: "text",
          text: "Confessa una piccola bugia bianca (o non così bianca) che hai detto a [PLAYER] per evitare di fare qualcosa.",
        },
        {
          type: "text",
          text: "Devi dire a [PLAYER] una verità scomoda ma costruttiva sul suo profilo social preferito.",
        },
        {
          type: "text",
          text: "Fai una domanda super personale a [PLAYER] (può usare un jolly e non rispondere, ma deve subire una piccola penitenza decisa dal gruppo).",
        },
        {
          type: "text",
          text: "[PLAYER], in una scala da 1 a 10, quanto consideri discutibile la tua ultima decisione importante? Spiega.",
        },
        {
          type: "text",
          text: "[PLAYER], se potessi creare una legge assurda ma che tutti devono seguire, quale sarebbe e perché?",
        },
        {
          type: "text",
          text: "[PLAYER], se i tuoi amici qui presenti creassero un documentario sulla tua vita, quale sarebbe il titolo più imbarazzante ma accurato?",
        },
        {
          type: "text",
          text: "[PLAYER], qual è la cosa più strana che hai cercato su Google o chatgpt nell'ultima settimana che non vorresti che gli altri sapessero?",
        },
        {
          type: "text",
          text: "[PLAYER], se il tuo animale domestico (o un oggetto in casa tua) potesse parlare, quale segreto imbarazzante rivelerebbe su di te?",
        },
        {
          type: "text",
          text: "[PLAYER], considerando i presenti, chi chiameresti alle 3 del mattino per aiutarti a nascondere un pinguino rubato dallo zoo? E perché?",
        },
        {
          type: "text",
          text: "[PLAYER], se i tuoi DM/messaggi privati venissero esposti pubblicamente, quale sarebbe la conversazione che ti metterebbe più in imbarazzo?",
        },
        {
          type: "text",
          text: "[PLAYER], quale serie o film ti vergogni segretamente di amare ma difenderesti con passione se qualcuno lo criticasse?",
        },
      ];
      const groupChallenges = [
        {
          type: "image",
          text: "Gruppo: chi qui dentro è più probabile che abbia un poster di *questo* in camera?",
          image: "images/Vecchia_baldracca.jpg",
        },
        {
          type: "image",
          text: "TUTTI: guardate attentamente quest'immagine dell'Uomo-Delfino. Al 'VIA!' del GM, dovete scatenare il vostro urlo di puro terrore più convincente.",
          image: "images/UOMO_FACCIA_DELFINO.jpg",
        }, // NOME FILE DA VERIFICARE
        {
          type: "text",
          text: "TUTTI (o i più coraggiosi): cantate insieme A CAPPELA il ritornello di 'My Heart Will Go On'. Metteteci sentimento!",
        },
        {
          type: "text",
          text: "Momento Orchestra Corporea: a turno, ogni giocatore deve fare un suono corporeo (schiocco dita, battito mani, pernacchia...) cercando di creare un ritmo collettivo assurdo.",
        },
        {
          type: "image",
          text: "Formate una statua di gruppo che rappresenti l'emozione suscitata da questa Maschera Inquietante. Avete 10 secondi!",
          image: "images/Maschera_bianca_inquietante_su_uomo.jpg",
        },
        {
          type: "text",
          text: "A turno, ogni giocatore deve dire una parola. L'obiettivo è creare collettivamente una frase di senso compiuto più lunga possibile, ma che sia completamente idiota.",
        },
        {
          type: "image",
          text: "Tutti insieme, come ci è finito questo ciccione viola nell'acqua? Spiegamelo perchè veramente non riesco a capire.",
          image: "images/Alieno_viola_in_foresta_fluorescente.jpg",
        },
        {
          type: "text",
          text: "Gioco del Sinonimo Improbabile: il GM dice una parola normale (es: 'felice'). A turno, dite un sinonimo sempre più strano e meno attinente (es: 'contento', 'gaio', 'pimpante', 'spumeggiante', 'fotosintetico'...). Chi esita o ripete è fuori (metaforicamente).",
        },
        {
          type: "image",
          text: "Tutti i giocatori devono camminare per la stanza imitando l'andatura fiera di questo Omino in Armatura.",
          image: "images/Omino_grasso_stile_cartoon_in_armatura.jpg",
        },
        {
          type: "text",
          text: "Ogni giocatore deve scegliere un altro giocatore e sussurrargli all'orecchio un complimento VERAMENTE imbarazzante. Le reazioni saranno giudicate!",
        },
        {
          type: "image",
          text: "Il gruppo deve decidere: chi potrebbe essere il proprietario di Woody Strafatto?",
          image: "images/woody_strafatto.jpg",
        },
        {
          type: "image",
          text: "Gruppo: questa immagine rappresenta l'umore medio di chi quando si sveglia? Votate!",
          image: "images/mood_mattutino.jpg",
        },
        {
          type: "text",
          text: "Gioco della sedia: un giocatore volontario dice che sedia si sente. Gli altri devono assegnargliene una più adatta.",
        },
        {
          type: "image",
          text: "Gruppo: assegnate il verso che farebbe questa chincillà umano.",
          image: "images/Lontra_umana_con_occhi_azzurri.jpg",
        },
        {
          type: "text",
          text: "Round di 'Obbligo o Verità' per un volontario. Il gruppo sceglie per lui/lei.",
        },
        {
          type: "image",
          text: "Gruppo: inventate collettivamente un titolo clickbait per un articolo sulla vita segreta di questo Gatto Vampiro.",
          image: "images/Gatto_arrabbiato_con_denti_da_vampiro.jpg",
        },
        {
          type: "text",
          text: "Complimento competitivo per un volontario: chi fa il complimento più originale vince.",
        },
        {
          type: "image",
          text: "Gruppo: descrivete come parlerebbe questo cane.",
          image: "images/Cane_con_faccia_stupita_e_sproporzionata.jpg",
        },
        {
          type: "image",
          text: "Tutti: imitate l'espressione di Shrek ora!",
          image: "images/Shrek_con_sorriso_memico.jpg",
        },
        {
          type: "text",
          text: "Domanda Trivia su un giocatore scelto a caso: chi risponde correttamente per primo vince.",
        },
        {
          type: "text",
          text: "Gruppo: ognuno faccia la sua migliore imitazione del suono di avvio di un vecchio computer Windows. I presenti votano la più realistica.",
        },
        {
          type: "text",
          text: "Gruppo: create collettivamente una ricetta di cucina usando solo oggetti visibili nella stanza. Più assurda è, meglio è!",
        },
        {
          type: "text",
          text: "Gruppo: catena di battute pessime - qualcuno inizia con una battuta davvero terribile, e a turno ognuno deve farne una peggiore della precedente.",
        },
        {
          type: "text",
          text: "Gruppo: ognuno deve inventare un soprannome ridicolo per la persona alla propria destra, basato su un incidente imbarazzante (reale o immaginario).",
        },
        {
          type: "text",
          text: "Gruppo: imitazione rapida - un volontario fa un gesto o un'espressione bizzarra, e tutti devono immediatamente copiarla il più accuratamente possibile.",
        },
        {
          type: "text",
          text: "Gruppo: create un breve telegiornale assurdo dove ogni persona aggiunge una notizia sempre più surreale, collegandola alla precedente.",
        },
        {
          type: "text",
          text: "Gruppo: inventate una danza di gruppo improbabile chiamata 'La Cancrena'. Ogni persona aggiunge un movimento e alla fine eseguitela tutti insieme.",
        },
        {
          type: "text",
          text: "Gruppo: date vita a un tribunale improvvisato dove si processa un oggetto presente nella stanza per crimini ridicoli. Assegnate i ruoli di giudice, accusa, difesa e testimoni.",
        },
      ]; // Rimosso [PLAYER=mittente]
      const coupleChallenges = [
        {
          type: "text",
          text: "Coppia ([COPPIA_1] & [COPPIA_2]): chi di voi due è più probabile che pianga guardando un cartone?",
        },
        {
          type: "text",
          text: "Coppia ([COPPIA_1] & [COPPIA_2]): descrivete a turno il partner usando solo rumori di animali. L'altro deve indovinare l'animale (e l'intenzione).",
        },
        {
          type: "image",
          text: "Coppia: chi dei due assomiglia di più a quest'Arancia con faccia di scimmia quando prova a fare il/la simpatico/a?",
          image: "images/Arancia_con_faccia_di_scimmia.jpg",
        },
        {
          type: "text",
          text: "Coppia: se foste bloccati su un'isola deserta, chi dei due sarebbe il capo e chi il suddito (o il pasto)? Giustificate.",
        },
        {
          type: "text",
          text: "Coppia: qual è la cosa più irritante che il vostro partner fa MA che trovate segretamente adorabile?",
        },
        {
          type: "image",
          text: "Uno di voi è Shrek, l'altro è Ciuchino in questa immagine. Chi è chi nella vostra dinamica di coppia in questo momento?",
          image: "images/Shrek_con_sorriso_memico.jpg",
        },
        {
          type: "text",
          text: "Coppia: dovete scambiarvi i ruoli per 1 minuto. Imitate il modo di parlare e le manie tipiche del partner.",
        },
        {
          type: "image",
          text: "Guardate questo Cane che Puzza. Coppia: qual è stata la figuraccia 'puzzolente' più grande che avete fatto insieme in pubblico?",
          image: "images/un_cane_puzza.jpg",
        },
        {
          type: "text",
          text: "Coppia: chi dei due è più probabile che inizi a ballare da solo/a in cucina mentre prepara la cena?",
        },
        {
          type: "image",
          text: "Se foste i protagonisti di un film horror e questo Gatto Vampiro fosse il mostro, chi dei due sopravviverebbe e come?",
          image: "images/Gatto_arrabbiato_con_denti_da_vampiro.jpg",
        },
        {
          type: "text",
          text: "Coppia: qual è la vostra 'canzone da disagio' segreta (quella che ascoltate ma vi vergognate un po')?",
        },
        {
          type: "text",
          text: "Inventate un nuovo gusto di pizza ispirato alla vostra relazione (es: 'Litigio e Riconciliazione al Gorgonzola', 'Passione e Ananas').",
        },
        {
          type: "image",
          text: "Coppia: questa immagine rappresenta la vostra domenica tipo? Siate onesti!",
          image: "images/relax_o_caos.jpg",
        },
        {
          type: "text",
          text: "Coppia: qual è il nomignolo più imbarazzante che usate tra voi?",
        },
        {
          type: "image",
          text: "Coppia: l'acconciatura di questa Scimmia è l'aspirazione segreta di chi dei due?",
          image: "images/Scimmia_caschetto_stile_moderno.jpg",
        },
        {
          type: "text",
          text: "Coppia: descrivete il partner ideale per l'altro/a usando solo nomi di personaggi dei cartoni.",
        },
        {
          type: "image",
          text: "Coppia: la faccia di questo cane rappresenta chi dei due dopo una lunga giornata?",
          image: "images/un_cane_puzza.jpg",
        },
        {
          type: "text",
          text: "Coppia: se foste un gusto di pizza combinato, quale sarebbe?",
        },
        {
          type: "text",
          text: "Coppia: chi dei due è più bravo/a a mentire? L'altro/a deve fornire una prova (aneddoto).",
        },
        {
          type: "image",
          text: "Coppia: chi dei due esagera di più nel raccontare storie, come suggerisce questo Uomo?",
          image: "images/Uomo_con_baffi_filter_volto_allungato.jpg",
        },
        {
          type: "text",
          text: "Coppia: inventate e mostrate un ballo di coppia segreto e imbarazzante.",
        },
        {
          type: "image",
          text: "Coppia: guardate l'Uovo. Senza parlare, indicate chi dei due è più 'secchione'.",
          image: "images/Uovo_con_occhiali_e_volto_umano.jpg",
        },
        {
          type: "text",
          text: "Coppia: se doveste scambiarvi un talento inutile per un giorno, quali?",
        },
        {
          type: "text",
          text: "Coppia ([COPPIA_1] & [COPPIA_2]): create un nuovo supereroe combinando i vostri 'poteri' e difetti peggiori. Come si chiama e quale sarebbe il suo costume?",
        },
        {
          type: "text",
          text: "Coppia: improvvisate una breve scena da telenovela drammatica dove uno di voi ha appena scoperto che l'altro è il suo gemello segreto.",
        },
        {
          type: "text",
          text: "Coppia: create una pubblicità per un prodotto assurdo che risolve un problema che solo voi due avete, alternandovi nelle frasi senza consultarvi prima.",
        },
        {
          type: "text",
          text: "Coppia: intervista assurda - uno fa domande totalmente random, l'altro deve rispondere seriamente come se fosse un esperto mondiale dell'argomento.",
        },
        {
          type: "text",
          text: "Coppia: dovete descrivere la giornata tipo dell'altro come se fosse un documentario di National Geographic sulle strane abitudini di una specie rara.",
        },
        {
          type: "text",
          text: "Coppia: create un nuovo sport estremo combinando i vostri hobby. Mostrate una 'mossa vincente' di questo sport e fatela commentare dagli altri.",
        },
        {
          type: "text",
          text: "Coppia: inventate una nuova festa nazionale basata sulle vostre personalità combinate. Quali sarebbero le tradizioni e i rituali di questa festa?",
        },
        {
          type: "text",
          text: "Coppia: dovete farvi a vicenda complimenti assurdamente specifici nello stile di un poeta drammatico dell'800. Chi fa il complimento più elaborato vince.",
        },
      ]; // Rimosso [MITTENTE]
      const challengeModeChallenges = [
        /* ...identici a prima... */ {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: sfida a chi imita meglio il suono di un modem 56k che si connette.",
        },
        {
          type: "text",
          text: "[PLAYER_1] vs [PLAYER_2]: Gara di Rutti Mentali. Chi riesce a mimare il rutto più impressionante senza fare rumore?",
        },
        {
          type: "image",
          text: "[PLAYER_1] vs [PLAYER_2]: Imitate l'espressione di terrore esistenziale di quest'Uovo con gli occhiali. Il più convincente vince.",
          image: "images/Uovo_con_occhiali_e_volto_umano.jpg",
        },
        {
          type: "text",
          text: "[PLAYER_1] vs [PLAYER_2]: Sfida a chi inventa la scusa più assurda e incredibile per non andare a un matrimonio.",
        },
        {
          type: "image",
          text: "[PLAYER_1] vs [PLAYER_2]: Chi riesce a rimanere serio più a lungo guardando fisso questo Cane Stupito?",
          image: "images/Cane_con_faccia_stupita_e_sproporzionata.jpg",
        },
        {
          type: "text",
          text: "[PLAYER_1] vs [PLAYER_2]: Sfida di Mimo Veloce. Il GM sussurra un oggetto strano a entrambi, chi lo mima meglio e più velocemente per farlo indovinare al gruppo vince.",
        },
        {
          type: "text",
          text: "[PLAYER_1] vs [PLAYER_2]: Gara a chi pronuncia più velocemente e correttamente la frase 'Trentatré trentini entrarono a Trento tutti e trentatré trotterellando'.",
        },
        {
          type: "image",
          text: "[PLAYER_1] vs [PLAYER_2]: Create una micro-sceneggiatura (2 battute a testa) per un dialogo tra la Casa Arrabbiata e l'Uomo-Baffo.",
          image: "images/Casa_con_faccia_umano_arrabbiato.jpg",
        }, // Immagine riferimento 1
        // { type: 'image', image: "images/Uomo_con_baffi_filter_volto_allungato.jpg"} // Immagine riferimento 2 - complesso da mostrare, forse meglio evitarlo o descrivere il secondo personaggio.
        {
          type: "text",
          text: "[PLAYER_1] vs [PLAYER_2]: Sfida a chi riesce a fare il maggior numero di flessioni... con un solo dito (anche mimandole) in 10 secondi.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: dovete fare braccio di ferro mentale. Fissatevi intensamente finché uno dei due non ride o distoglie lo sguardo. Vietato toccarsi.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: sfida di sguardi assassini. Chi mantiene lo sguardo più minaccioso per 15 secondi vince.",
        },
        {
          type: "image",
          text: "[PLAYER_1] e [PLAYER_2]: chi dei due riesce a imitare meglio la posa di questo Gatto Kung Fu? Il gruppo giudica.",
          image: "images/Gatto_allungato_mossa_KungFu.jpg",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: gara a chi racconta la barzelletta più squallida e imbarazzante.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: sfida a chi riesce a stare in equilibrio su una gamba sola per più tempo (senza appoggiarsi!).",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: sfida a chi fa il verso di animale più strano e inaspettato.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: gara di complimenti passivo-aggressivi. Chi riesce a farne uno più tagliente ma velato vince.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: dovete recitare la scena madre di un film famoso ma usando solo la parola 'Cancrena'.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: gara a chi riesce a ridere in modo più malvagio e inquietante. Il gruppo decide il vincitore.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: sfida di beatbox improvvisato - ciascuno ha 15 secondi per creare il ritmo più assurdo possibile.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: dovete improvvisare un rap battle usando solo parole che iniziano con la prima lettera del nome dell'avversario.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: sfida delle espressioni facciali - mostrate la vostra migliore faccia da 'ho appena morso un limone mentre ricevo una multa'.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: sfida di mimo - interpretate l'emozione 'delusione cosmica' usando solo il vostro corpo, senza fare alcun suono.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: gara a chi inventa la scusa più assurda per non aver fatto i compiti, come se parlaste con un insegnante severo.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: sfida di danza assurda - dovete ballare nello stile di un animale improbabile (un bradipo, un granchio, ecc.). Il gruppo vota il migliore.",
        },
        {
          type: "text",
          text: "[PLAYER_1] e [PLAYER_2]: vi sfido a cantare il titolo di una canzone famosa con l'accento più strano possibile. Gli altri devono indovinare la canzone.",
        },
      ];

      // -------- FUNZIONI UI e SETUP --------
      // (createScoreboardItem, updatePlayerScoreVisual, updateScoreboardSidebar - invariate rispetto all'ultima versione)
      function createScoreboardItem(playerName) {
        const li = document.createElement("li");
        li.className = "score-item";
        li.dataset.playerName = playerName;
        const nameSpan = document.createElement("span");
        nameSpan.className = "score-name";
        nameSpan.textContent = playerName;
        const pointsSpan = document.createElement("span");
        pointsSpan.className = "score-points";
        pointsSpan.textContent = "0";
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "score-actions";
        actionsDiv.style.display = "none";
        const likeBtn = document.createElement("button");
        likeBtn.className = "like-btn";
        likeBtn.title = "Assegna Punto (+1)";
        likeBtn.innerHTML = "👍";
        likeBtn.style.display = "none";
        likeBtn.onclick = (event) => {
          event.stopPropagation();
          assignPoints(playerName, "like");
        };
        actionsDiv.appendChild(likeBtn);
        const dislikeBtn = document.createElement("button");
        dislikeBtn.className = "dislike-btn";
        dislikeBtn.title = "Nessun Punto";
        dislikeBtn.innerHTML = "👎";
        dislikeBtn.style.display = "none";
        dislikeBtn.onclick = (event) => {
          event.stopPropagation();
          assignPoints(playerName, "dislike");
        };
        actionsDiv.appendChild(dislikeBtn);
        const voteBtn = document.createElement("button");
        voteBtn.className = "vote-winner-btn";
        voteBtn.title = "Vincitore Sfida!";
        voteBtn.innerHTML = "";
        voteBtn.style.display = "none";
        voteBtn.onclick = (event) => {
          event.stopPropagation();
          assignPoints(playerName, "challengeWin");
        };
        actionsDiv.appendChild(voteBtn);
        li.appendChild(nameSpan);
        li.appendChild(pointsSpan);
        li.appendChild(actionsDiv);
        return li;
      }
      function updateScoreboardSidebar() {
        const scoreboardList = document.getElementById("scoreboard-list");
        scoreboardList.innerHTML = "";
        players.forEach((player) => {
          const scoreItem = createScoreboardItem(player);
          scoreboardList.appendChild(scoreItem);
          updatePlayerScoreVisual(player);
        });
      }
      function updatePlayerScoreVisual(playerName) {
        const scoreItem = document.querySelector(
          `#scoreboard-list .score-item[data-player-name="${playerName}"]`
        );
        if (scoreItem) {
          const pointsSpan = scoreItem.querySelector(".score-points");
          if (pointsSpan) {
            pointsSpan.textContent =
              playerScores[playerName] !== undefined
                ? playerScores[playerName]
                : 0;
          }
        }
      }

      // --- Funzioni Setup Giocatori/Coppie (invariate) ---
      function addPlayer() {
        const playerNameInput = document.getElementById("player-name");
        const playerName = playerNameInput.value.trim();
        if (playerName && !players.includes(playerName)) {
          players.push(playerName);
          playerScores[playerName] = 0;
          updatePlayersList();
          /* updateScoreboardSidebar viene chiamata da updatePlayersList */ playerNameInput.value =
            "";
          document.getElementById("start-btn").disabled = players.length < 2;
          updateCoupleSectionVisibility();
        } else if (players.includes(playerName)) {
          alert("Questo giocatore esiste già!");
        }
        playerNameInput.focus();
      }
      function removePlayer(index) {
        const playerName = players[index];
        const wasInCouple = isPlayerInCouple(playerName);
        players.splice(index, 1);
        delete playerScores[playerName];
        if (wasInCouple) {
          couples = couples.filter((couple) => !couple.includes(playerName));
        }
        updatePlayersList();
        /* updateScoreboardSidebar viene chiamata da updatePlayersList */ document.getElementById(
          "start-btn"
        ).disabled = players.length < 2;
        updateCoupleSectionVisibility();
      }
      function updatePlayersList() {
        const playersListElement = document.getElementById("players-list");
        playersListElement.innerHTML = "";
        players.forEach((player, index) => {
          const li = document.createElement("li");
          li.className = "player-item";
          const nameSpan = document.createElement("span");
          nameSpan.className = "player-name";
          nameSpan.textContent = player;
          li.appendChild(nameSpan);
          const actionsDiv = document.createElement("div");
          actionsDiv.className = "player-actions";
          const coupleIconSpan = document.createElement("span");
          coupleIconSpan.className = "couple-icon";
          actionsDiv.appendChild(coupleIconSpan);
          const uncoupleBtn = document.createElement("button");
          uncoupleBtn.className = "uncouple-btn";
          uncoupleBtn.textContent = "Separa";
          uncoupleBtn.onclick = () => uncouplePlayers(player);
          actionsDiv.appendChild(uncoupleBtn);
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete-btn";
          deleteBtn.textContent = "Rimuovi";
          deleteBtn.onclick = () => removePlayer(index);
          actionsDiv.appendChild(deleteBtn);
          li.appendChild(actionsDiv);
          playersListElement.appendChild(li);
          updatePlayerCoupleStatusVisual(player);
        });
        updateScoreboardSidebar();
        /* Aggiorna ANCHE sidebar */ if (
          document.getElementById("setup-section").style.display === "block"
        ) {
          if (players.length >= 2) {
            updateCoupleDropdowns();
          }
        }
      }
      function isPlayerInCouple(playerName) {
        return couples.some((couple) => couple.includes(playerName));
      }
      function updatePlayerCoupleStatusVisual(playerName) {
        document.querySelectorAll("#players-list li").forEach((li) => {
          const nameSpan = li.querySelector(".player-name");
          if (nameSpan && nameSpan.textContent === playerName) {
            const coupleIconSpan = li.querySelector(".couple-icon");
            const uncoupleBtn = li.querySelector(".uncouple-btn");
            if (isPlayerInCouple(playerName)) {
              coupleIconSpan.textContent = " ❤️";
              uncoupleBtn.style.display = "inline-block";
            } else {
              coupleIconSpan.textContent = "";
              uncoupleBtn.style.display = "none";
            }
          }
        });
      }
      function updateCoupleSectionVisibility() {
        const coupleSection = document.getElementById("couple-section");
        const shouldBeVisible = players.length >= 2;
        coupleSection.style.display = shouldBeVisible ? "block" : "none";
        if (!shouldBeVisible && couples.length > 0) {
          couples = [];
          updatePlayersList(); /* Aggiorna lista e sidebar se coppie resettate */
        }
        if (shouldBeVisible) {
          updateCoupleDropdowns();
        }
      }
      function updateCoupleDropdowns() {
        const select1 = document.getElementById("couple-player1");
        const select2 = document.getElementById("couple-player2");
        if (!select1 || !select2) return;
        const currentVal1 = select1.value;
        const currentVal2 = select2.value;
        select1.innerHTML = '<option value="">Seleziona...</option>';
        select2.innerHTML = '<option value="">Seleziona...</option>';
        const availablePlayers = players.filter((p) => !isPlayerInCouple(p));
        availablePlayers.forEach((player) => {
          const option1 = document.createElement("option");
          option1.value = player;
          option1.textContent = player;
          select1.appendChild(option1);
          const option2 = document.createElement("option");
          option2.value = player;
          option2.textContent = player;
          select2.appendChild(option2);
        });
        if (availablePlayers.includes(currentVal1)) select1.value = currentVal1;
        if (availablePlayers.includes(currentVal2)) select2.value = currentVal2;
        document.getElementById("couple-btn").disabled =
          availablePlayers.length < 2;
      }
      function formCouple() {
        const player1 = document.getElementById("couple-player1").value;
        const player2 = document.getElementById("couple-player2").value;
        if (!player1 || !player2) {
          alert("Seleziona entrambi i giocatori!");
          return;
        }
        if (player1 === player2) {
          alert("I giocatori devono essere diversi!");
          return;
        }
        couples.push([player1, player2]);
        updatePlayersList();
        /* Aggiorna lista e sidebar */ document.getElementById(
          "couple-player1"
        ).value = "";
        document.getElementById("couple-player2").value = "";
      }
      function uncouplePlayers(playerName) {
        couples = couples.filter((couple) => !couple.includes(playerName));
        updatePlayersList(); /* Aggiorna lista e sidebar */
      }

      // -------- FUNZIONI FLUSSO DI GIOCO --------

      function startGame() {
        if (players.length < 2) return;
        players.forEach((player) => {
          playerScores[player] = 0;
        });
        updateScoreboardSidebar();

        currentChallengeData = null;

        document.getElementById("setup-section").style.display = "none";
        document.getElementById("scoreboard-section").style.display = "none";
        document.getElementById("game-section").style.display = "block";
        document.getElementById("scoreboard-sidebar").style.display = "block";
        document.getElementById("general-laugh-btn").style.display = "none";
        document
          .querySelectorAll(".score-actions")
          .forEach((div) => (div.style.display = "none"));
        document.getElementById("next-btn").disabled = true;
        nextChallenge();
      }

      function determineChallengeType() {
        /* ...identica a prima... */ const rand = Math.random() * 100;
        let cumulativeProb = 0;
        cumulativeProb += coupleChallengeProbability;
        if (couples.length > 0 && rand < cumulativeProb) {
          return { pool: coupleChallenges, type: "couple" };
        }
        cumulativeProb += groupChallengeProbability;
        if (rand < cumulativeProb) {
          return { pool: groupChallenges, type: "group" };
        }
        cumulativeProb += challengeModeProbability;
        if (players.length >= 2 && rand < cumulativeProb) {
          return { pool: challengeModeChallenges, type: "challenge" };
        }
        const oneVsOnePool = [
          ...compliments,
          ...roasts,
          ...uncomfortableQuestions,
        ];
        return { pool: oneVsOnePool, type: "single" };
      }

      // *** VERSIONE MODIFICATA DI selectParticipants ***
      function selectParticipants(targetType) {
        let fromPlayer = null; // Mittente (solo per 'single')
        let player1 = null; // Sfidante 1
        let player2 = null; // Sfidante 2
        let toTarget = null; // Target (nome, 'TUTTI', coppia)
        let currentTargetType = targetType;
        let currentPool = null;

        if (targetType === "challenge") {
          if (players.length < 2) return null;
          let indices = Array.from(players.keys());
          let index1 = indices.splice(
            Math.floor(Math.random() * indices.length),
            1
          )[0];
          let index2 = indices.splice(
            Math.floor(Math.random() * indices.length),
            1
          )[0];
          player1 = players[index1];
          player2 = players[index2];
          // fromPlayer rimane null
          // toTarget rimane null
        } else if (targetType === "couple") {
          if (couples.length === 0) {
            // Fallback
            currentTargetType = "group";
            currentPool = groupChallenges;
          } else {
            toTarget = couples[Math.floor(Math.random() * couples.length)];
            // Decidiamo che per le sfide coppia, il 'mittente' è irrilevante
            fromPlayer = null; // <-- CAMBIAMENTO: non selezioniamo mittente per coppie
          }
        } else if (targetType === "group") {
          // Non serve un mittente esplicito per la logica di scoring
          fromPlayer = null; // <-- CAMBIAMENTO
          toTarget = "TUTTI";
          // Potremmo comunque selezionare un giocatore FOCUS internamente se le domande lo richiedono
          // ma non lo usiamo per lo scoring o il display principale
          // let focusPlayer = players[Math.floor(Math.random() * players.length)]; // Esempio
        } else if (targetType === "single") {
          if (players.length < 2) {
            // Fallback se solo 1 giocatore
            currentTargetType = "group";
            currentPool = groupChallenges;
            toTarget = "TUTTI";
            fromPlayer = null;
          } else {
            fromPlayer = players[Math.floor(Math.random() * players.length)]; // Seleziona mittente
            let potentialTargets = players.filter((p) => p !== fromPlayer);
            toTarget =
              potentialTargets[
                Math.floor(Math.random() * potentialTargets.length)
              ];
          }
        }

        // Verifica finale coerenza
        if (currentTargetType === "challenge" && (!player1 || !player2))
          return null;
        // Per gli altri tipi, ora non necessariamente serve fromPlayer
        if (currentTargetType === "single" && (!fromPlayer || !toTarget))
          return null;
        if (currentTargetType === "couple" && !toTarget) return null; // Serve solo target coppia
        if (currentTargetType === "group" && toTarget !== "TUTTI") return null;

        return {
          from: fromPlayer, // Sarà null tranne per 'single'
          player1: player1,
          player2: player2,
          to: toTarget,
          type: currentTargetType,
          poolOverride: currentPool,
        };
      }

      // *** VERSIONE MODIFICATA DI determineScorablePlayers ***
      function determineScorablePlayers(challengeData) {
        if (!challengeData) return [];
        const type = challengeData.targetType;

        if (type === "single") {
          // Premiamo il mittente (chi fa complimento/roast)
          return challengeData.fromDisplay ? [challengeData.fromDisplay] : [];
        } else if (type === "couple") {
          // Premiamo entrambi i membri della coppia target
          return challengeData.toDisplay &&
            Array.isArray(challengeData.toDisplay)
            ? [...challengeData.toDisplay]
            : [];
        } else if (type === "challenge") {
          // Possibili vincitori sono gli sfidanti
          return [challengeData.player1, challengeData.player2];
        } else if (type === "group") {
          // Nessun scorable individuale, c'è il bottone generale
          return [];
        }
        return [];
      }

      // *** VERSIONE MODIFICATA DI updateChallengeUI ***
      function updateChallengeUI() {
        if (!currentChallengeData) return;
        const card = document.getElementById("challenge-card");
        const pairElement = document.getElementById("current-pair");
        const textElement = document.getElementById("challenge-text");
        const imageContainer = document.getElementById(
          "challenge-image-container"
        );
        const imageElement = document.getElementById("challenge-image");

        // Reset card e header
        card.className = "challenge-card"; // Rimuove classi specifiche precedenti
        pairElement.textContent = ""; // Pulisce header

        // Costruisci Header Display in base al tipo
        let displayHeader = "";
        const type = currentChallengeData.targetType;

        if (type === "couple") {
          card.classList.add("couple-challenge");
          // Ora mostra SOLO la coppia target
          displayHeader = `COPPIA: ${currentChallengeData.toDisplay[0]} & ${currentChallengeData.toDisplay[1]}`;
        } else if (type === "group") {
          card.classList.add("group-challenge");
          // Ora mostra SOLO TUTTI
          displayHeader = "SFIDA DI GRUPPO"; // O semplicemente "TUTTI" o niente? Proviamo così.
        } else if (type === "challenge") {
          card.classList.add("challenge-mode");
          displayHeader = `SFIDA: ${currentChallengeData.player1} vs ${currentChallengeData.player2}`;
        } else {
          // single
          // Mostra Mittente -> Target solo qui
          displayHeader = `${currentChallengeData.fromDisplay} → ${currentChallengeData.toDisplay}`;
        }
        pairElement.textContent = displayHeader;

        // Immagine e Testo (come prima)
        if (currentChallengeData.image) {
          imageElement.src = currentChallengeData.image;
          imageContainer.style.display = "block";
        } else {
          imageContainer.style.display = "none";
          imageElement.src = "";
        }
        textElement.textContent = currentChallengeData.challenge;

        // Bottone Risate Generali (gestito da updateSidebarHighlightAndActions)
      }

      // *** VERSIONE MODIFICATA di updateSidebarHighlightAndActions ***
      function updateSidebarHighlightAndActions() {
        const scorablePlayers = determineScorablePlayers(currentChallengeData);
        console.log("Giocatori Scorable:", scorablePlayers); // DEBUG

        document
          .querySelectorAll("#scoreboard-list .score-item")
          .forEach((item) => {
            const playerName = item.dataset.playerName;
            const actionsDiv = item.querySelector(".score-actions");
            const likeBtn = actionsDiv?.querySelector(".like-btn");
            const dislikeBtn = actionsDiv?.querySelector(".dislike-btn");
            const voteBtn = actionsDiv?.querySelector(".vote-winner-btn");

            // Reset
            item.classList.remove("highlight");
            actionsDiv.style.display = "none";
            if (likeBtn) {
              likeBtn.style.display = "none";
              likeBtn.disabled = true;
            }
            if (dislikeBtn) {
              dislikeBtn.style.display = "none";
              dislikeBtn.disabled = true;
            }
            if (voteBtn) {
              voteBtn.style.display = "none";
              voteBtn.disabled = true;
            }

            // Se giocatore è scorable
            if (scorablePlayers.includes(playerName)) {
              item.classList.add("highlight");
              actionsDiv.style.display = "flex";

              const isChallengeMode =
                currentChallengeData?.targetType === "challenge";

              if (isChallengeMode) {
                // Mostra 🏆 per sfide
                if (voteBtn) {
                  voteBtn.style.display = "inline-block";
                  voteBtn.disabled = false;
                }
              } else {
                // Mostra 👍/👎 per single/couple
                if (likeBtn) {
                  likeBtn.style.display = "inline-block";
                  likeBtn.disabled = false;
                }
                if (dislikeBtn) {
                  dislikeBtn.style.display = "inline-block";
                  dislikeBtn.disabled = false;
                }
              }
            }
          });

        // Bottone Risate Generali
        const generalLaughBtn = document.getElementById("general-laugh-btn");
        if (generalLaughBtn) {
          const isGroup = currentChallengeData?.targetType === "group";
          generalLaughBtn.style.display = isGroup ? "block" : "none";
          generalLaughBtn.disabled = !isGroup;
        }
      }

      // nextChallenge (aggiornata per usare la nuova selectParticipants)
      function nextChallenge() {
        if (players.length === 0) {
          endGame();
          return;
        }

        const challengeInfo = determineChallengeType();
        let participationInfo = selectParticipants(challengeInfo.type); // Ora ritorna from=null per non-single

        if (!participationInfo) {
          /* ... gestione fallback ... */ console.warn(
            "Selezione fallita, forzo gruppo."
          );
          if (players.length > 0) {
            participationInfo = {
              from: null,
              to: "TUTTI",
              type: "group",
              poolOverride: groupChallenges,
            };
            challengeInfo.pool = groupChallenges;
            challengeInfo.type = "group";
          } else {
            endGame();
            return;
          }
        }

        let currentPool = participationInfo.poolOverride || challengeInfo.pool;
        let finalTargetType = participationInfo.type;

        if (!currentPool || currentPool.length === 0) {
          /* ... fallback pool vuoto ... */
        }

        let challenge =
          currentPool[Math.floor(Math.random() * currentPool.length)];
        let challengeTextContent = challenge.text;
        let challengeImagePath =
          challenge.type === "image" && challenge.image
            ? challenge.image
            : null;

        // Sostituzione Placeholder (Modificata per gestire from=null)
        let finalChallengeText = challengeTextContent;
        if (finalTargetType === "challenge") {
          finalChallengeText = finalChallengeText
            .replace(/\[PLAYER_1\]/g, participationInfo.player1)
            .replace(/\[PLAYER_2\]/g, participationInfo.player2);
        } else if (finalTargetType === "single") {
          // Qui 'from' esiste
          finalChallengeText = finalChallengeText
            .replace(/\[MITTENTE\]/g, participationInfo.from)
            .replace(/\[PLAYER\]/g, participationInfo.to);
        } else if (finalTargetType === "group") {
          // Rimuovi [MITTENTE] se presente, o sostituisci [PLAYER] con info generica se serve
          // Scegliamo un giocatore focus SOLO per la sostituzione nel testo, se serve
          let focusPlayer = players[Math.floor(Math.random() * players.length)];
          finalChallengeText = finalChallengeText
            .replace(/\[MITTENTE\]/g, "Gioco")
            .replace(/\[PLAYER\]/g, focusPlayer); // Sostituisce [PLAYER] con un nome a caso per contesto
        } else if (finalTargetType === "couple") {
          // Rimuovi [MITTENTE] se presente
          finalChallengeText = finalChallengeText
            .replace(/\[MITTENTE\]/g, "Gioco")
            .replace(/\[COPPIA_1\]/g, participationInfo.to[0])
            .replace(/\[COPPIA_2\]/g, participationInfo.to[1])
            .replace(
              /\[PLAYER\]/g,
              `la coppia ${participationInfo.to[0]} & ${participationInfo.to[1]}`
            );
        }

        // Salva dati sfida
        currentChallengeData = {
          targetType: finalTargetType,
          player1: participationInfo.player1,
          player2: participationInfo.player2,
          fromDisplay: participationInfo.from, // Può essere null
          toDisplay: participationInfo.to,
          challenge: finalChallengeText,
          image: challengeImagePath,
        };

        updateChallengeUI();
        updateSidebarHighlightAndActions(); // Chiamata DOPO aver definito currentChallengeData
        document.getElementById("next-btn").disabled = false;
      }

      // assignPoints, assignGroupPoints, disableActionsAndAdvance (INVARIATE)
      function assignPoints(playerName, scoreType) {
        if (!currentChallengeData) return;
        const scorablePlayers = determineScorablePlayers(currentChallengeData);
        if (!scorablePlayers.includes(playerName)) return;
        let pointsToAdd = 0;
        if (scoreType === "like") pointsToAdd = likePoints;
        else if (scoreType === "dislike") pointsToAdd = dislikePoints;
        else if (scoreType === "challengeWin") pointsToAdd = challengeWinPoints;
        if (playerScores.hasOwnProperty(playerName)) {
          playerScores[playerName] += pointsToAdd;
          updatePlayerScoreVisual(playerName);
          console.log(
            `${playerName} riceve ${pointsToAdd} punti (${scoreType}). Totale: ${playerScores[playerName]}`
          );
        }
        disableActionsAndAdvance();
      }
      function assignGroupPoints() {
        if (
          !currentChallengeData ||
          currentChallengeData.targetType !== "group"
        )
          return;
        players.forEach((player) => {
          if (playerScores.hasOwnProperty(player)) {
            playerScores[player] += groupLaughPoints;
            updatePlayerScoreVisual(player);
          }
        });
        console.log(`Risate generali! +${groupLaughPoints} punti a tutti.`);
        disableActionsAndAdvance();
      }
      function disableActionsAndAdvance() {
        document
          .querySelectorAll(".score-actions button")
          .forEach((btn) => (btn.disabled = true));
        const generalLaughBtn = document.getElementById("general-laugh-btn");
        if (generalLaughBtn) generalLaughBtn.disabled = true;
        document.getElementById("next-btn").disabled = true;
        document
          .querySelectorAll("#scoreboard-list .score-item.highlight")
          .forEach((item) => {
            item.classList.remove("highlight");
            item.querySelector(".score-actions").style.display = "none";
          });
        setTimeout(() => {
          nextChallenge();
        }, 1300);
      }

      // endGame, resetGame (INVARIATE)
      function endGame() {
        /* ... come prima ... */ document.getElementById(
          "game-section"
        ).style.display = "none";
        document.getElementById("scoreboard-sidebar").style.display = "none";
        document.getElementById("scoreboard-section").style.display = "block";
        document.getElementById("setup-section").style.display = "none";
        const sortedPlayers = Object.keys(playerScores)
          .filter((p) => players.includes(p))
          .sort((a, b) => playerScores[b] - playerScores[a]);
        const scoreListFinal = document.getElementById("score-list-final");
        scoreListFinal.innerHTML = "";
        if (sortedPlayers.length > 0) {
          const winnerScore = playerScores[sortedPlayers[0]];
          sortedPlayers.forEach((player, index) => {
            const scoreItem = createScoreboardItem(player);
            const actionsDiv = scoreItem.querySelector(".score-actions");
            if (actionsDiv) actionsDiv.remove();
            if (playerScores[player] === winnerScore && winnerScore > 0)
              scoreItem.classList.add("winner");
            const nameSpan = scoreItem.querySelector(".score-name");
            nameSpan.textContent = `${index + 1}. ${player}`;
            const pointsSpan = scoreItem.querySelector(".score-points");
            pointsSpan.textContent =
              playerScores[player] !== undefined ? playerScores[player] : 0;
            scoreListFinal.appendChild(scoreItem);
          });
        } else {
          scoreListFinal.innerHTML =
            '<p style="text-align: center;">Nessun punteggio disponibile.</p>';
        }
      }
      function resetGame() {
        /* ... come prima ... */ players = [];
        couples = [];
        playerScores = {};
        currentChallengeData = null;
        document.getElementById("setup-section").style.display = "block";
        document.getElementById("game-section").style.display = "none";
        document.getElementById("scoreboard-section").style.display = "none";
        document.getElementById("scoreboard-sidebar").style.display = "none";
        document.getElementById("scoreboard-list").innerHTML = "";
        document.getElementById("players-list").innerHTML = "";
        document.getElementById("player-name").value = "";
        document.getElementById("couple-section").style.display = "none";
        if (document.getElementById("couple-player1"))
          document.getElementById("couple-player1").innerHTML =
            '<option value="">Seleziona...</option>';
        if (document.getElementById("couple-player2"))
          document.getElementById("couple-player2").innerHTML =
            '<option value="">Seleziona...</option>';
        if (document.getElementById("couple-btn"))
          document.getElementById("couple-btn").disabled = true;
        if (document.getElementById("start-btn"))
          document.getElementById("start-btn").disabled = true;
      }

      // Event listener Invio e Setup iniziale
      const playerNameInput = document.getElementById("player-name");
      if (playerNameInput) {
        playerNameInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            addPlayer();
          }
        });
      }
      resetGame();
    </script>
  </body>
</html>
